<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <title>ä»Šæ—¥ã®ä¸€æ­©ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #111827;
      --bg-softer: #020617;
      --accent: #38bdf8;
      --accent-soft: #0f766e;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2933;
      --danger: #f97373;
      --good: #4ade80;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%, #000 100%);
      color: var(--text);
    }

    header {
      padding: 16px 20px 8px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(90deg, rgba(56, 189, 248, 0.16), rgba(15, 118, 110, 0.08));
    }

    header h1 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.04em;
    }

    header p {
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    main {
      padding: 12px 20px 20px;
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.4fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: rgba(15, 23, 42, 0.92);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 12px 14px 14px;
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.45);
    }

    /* TOD Buttons */
    .tod-wrap {
      display: flex;
      gap: 4px;
    }

    .btn-tod {
      background: transparent;
      border: 1px solid #334155;
      color: #64748b;
      border-radius: 4px;
      padding: 2px 4px;
      cursor: pointer;
      font-size: 10px;
      transition: all 0.2s;
    }

    .btn-tod:hover {
      border-color: #94a3b8;
      color: #94a3b8;
    }

    .btn-tod.active {
      background: rgba(56, 189, 248, 0.2);
      border-color: #38bdf8;
      color: #e0f2fe;
    }

    .panel-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 8px;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .panel-title span.badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--muted);
    }

    .panel-header small {
      margin-left: auto;
      font-size: 11px;
      color: var(--muted);
      text-align: right;
    }

    .metrics-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .metric-card {
      flex: 1 1 90px;
      min-width: 90px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(15, 118, 110, 0.25));
      border-radius: 10px;
      border: 1px solid rgba(56, 189, 248, 0.3);
      padding: 6px 8px;
    }

    .metric-label {
      font-size: 11px;
      color: var(--muted);
    }

    .metric-value {
      margin-top: 2px;
      font-size: 18px;
      font-weight: 600;
    }

    .metric-sub {
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .file-input-wrap {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
      flex-wrap: wrap;
    }

    .file-input-wrap label {
      padding: 4px 8px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      cursor: pointer;
      font-size: 11px;
    }

    .file-input-wrap input[type="file"] {
      display: none;
    }

    select,
    input,
    textarea,
    button {
      font-family: inherit;
      font-size: 13px;
    }

    select,
    input[type="date"],
    input[type="text"] {
      background: #020617;
      color: var(--text);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 4px 8px;
    }

    .daily-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .daily-title {
      font-size: 13px;
      font-weight: 600;
    }

    .daily-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .score-pill {
      display: inline-flex;
      align-items: baseline;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 118, 110, 0.35);
      border: 1px solid rgba(45, 212, 191, 0.6);
      font-size: 11px;
    }

    .score-pill strong {
      font-size: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: rgba(15, 23, 42, 0.9);
    }

    th,
    td {
      padding: 4px 6px;
      text-align: left;
      border-bottom: 1px solid rgba(15, 23, 42, 0.9);
      vertical-align: top;
    }

    th {
      font-size: 11px;
      color: var(--muted);
      font-weight: 500;
      white-space: nowrap;
    }

    tbody tr:nth-child(2n) td {
      background: rgba(15, 23, 42, 0.55);
    }

    .entry-text {
      white-space: normal;
      word-break: break-all;
      min-width: 120px;
      /* æ¥µç«¯ã«ç‹­ããªã‚‹ã®ã‚’é˜²ã */
    }

    #dailyTableWrap table {
      width: 100%;
      border-collapse: collapse;
    }

    .category-bar {
      margin-bottom: 6px;
    }

    .category-bar-header {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .category-bar-fill {
      position: relative;
      height: 8px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      border: 1px solid rgba(30, 64, 175, 0.7);
    }

    .category-bar-fill span {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 0;
      background: linear-gradient(90deg, #38bdf8, #22c55e);
      transition: width 0.4s ease-out;
    }

    .next-step-box {
      margin-top: 8px;
      padding: 8px 9px;
      border-radius: 10px;
      background: radial-gradient(circle at left, rgba(56, 189, 248, 0.25), rgba(15, 23, 42, 0.9));
      border: 1px solid rgba(56, 189, 248, 0.5);
    }

    .next-step-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .next-step-main {
      font-size: 13px;
      line-height: 1.4;
    }

    .next-step-main strong {
      color: var(--good);
    }

    form {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    textarea {
      width: 100%;
      min-height: 70px;
      resize: vertical;
      background: #020617;
      color: var(--text);
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 6px 8px;
    }

    .form-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .form-row label {
      font-size: 11px;
      color: var(--muted);
    }

    .form-row input[type="date"] {
      font-size: 12px;
      padding: 3px 8px;
    }

    button.primary {
      padding: 5px 10px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(90deg, #38bdf8, #22c55e);
      color: #020617;
      font-weight: 600;
      cursor: pointer;
      font-size: 12px;
    }

    button.primary:hover {
      filter: brightness(1.05);
    }

    .btn-ghost {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: transparent;
      color: var(--muted);
      font-size: 11px;
      cursor: pointer;
    }

    .btn-ghost:hover {
      background: rgba(15, 23, 42, 0.8);
      color: #e5e7eb;
    }

    /* å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆè½ã¡ç€ã„ãŸã‚°ãƒ¬ãƒ¼ï¼‰ */
    .btn-danger {
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: transparent;
      color: var(--muted);
      font-size: 10px;
      cursor: pointer;
    }

    .btn-danger:hover {
      background: rgba(15, 23, 42, 0.8);
      color: #e5e7eb;
    }

    /* ã‚¹ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆå‰å¤§ãªä¸€æ­©ãƒãƒ¼ã‚¯ï¼‰ */
    .btn-star {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: transparent;
      color: var(--muted);
      font-size: 14px;
      cursor: pointer;
      margin-right: 6px;
      transition: all 0.2s ease;
    }

    .btn-star:hover {
      border-color: #fbbf24;
      color: #fbbf24;
      background: rgba(251, 191, 36, 0.1);
    }

    .btn-star.starred {
      color: #fbbf24;
      border-color: #fbbf24;
      background: rgba(251, 191, 36, 0.15);
    }

    /* TODãƒœã‚¿ãƒ³ */
    .btn-tod {
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: transparent;
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
      margin-right: 2px;
      padding: 2px 4px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .btn-tod:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn-tod.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .form-note {
      font-size: 10px;
      color: var(--muted);
    }

    .message {
      font-size: 11px;
      margin-top: 2px;
    }

    .message.ok {
      color: var(--good);
    }

    .message.err {
      color: var(--danger);
    }

    .empty-state {
      font-size: 12px;
      color: var(--muted);
      padding: 8px 4px;
    }

    /* --- Bento Grid Layout --- */
    .lab-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      max-width: 1200px;
      margin: 0 auto;
      padding-bottom: 40px;
    }

    .lab-card {
      /* Glassmorphism Base */
      background: rgba(15, 23, 42, 0.6) !important;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
      border-radius: 16px !important;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .lab-card:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
      border-color: rgba(255, 255, 255, 0.2) !important;
      transform: translateY(-2px);
    }

    .span-full {
      grid-column: 1 / -1;
    }

    .span-1 {
      grid-column: span 1;
    }

    .span-2 {
      grid-column: span 2;
    }

    @media (max-width: 900px) {
      .lab-grid {
        grid-template-columns: 1fr 1fr;
      }

      .span-1 {
        grid-column: span 1;
      }
    }

    @media (max-width: 600px) {
      .lab-grid {
        grid-template-columns: 1fr;
      }

      .span-1,
      .span-2 {
        grid-column: 1 / -1;
      }
    }

    /* ------------------------- */

    .pill {

      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 10px;
      color: var(--muted);
    }

    /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    .tab-nav {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 12px;
    }

    .tab-btn {
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 14px;
      font-weight: 600;
      padding: 6px 12px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      color: var(--text);
    }

    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ¶å¾¡ */
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Future Lab ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .lab-container {
      display: grid;
      grid-template-columns: 1fr;
      /* ãƒ¢ãƒã‚¤ãƒ«ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ */
      gap: 20px;
      padding-bottom: 40px;
    }

    @media (min-width: 768px) {
      .lab-container {
        grid-template-columns: repeat(2, 1fr);
      }

      .lab-full-width {
        grid-column: span 2;
      }
    }

    .lab-card {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      backdrop-filter: blur(8px);
    }

    .lab-title {
      font-size: 14px;
      color: var(--muted);
      margin: 0 0 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .lab-chart-wrap {
      position: relative;
      height: 250px;
      width: 100%;
    }

    .category-select {
      width: 100%;
      background: #020617;
      color: var(--text);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 10px;
      padding: 2px 4px;
    }

    /* æ¬¡ã®ä¸€æ­©ãƒ¡ãƒ¢ç”¨ */
    .next-memo-list {
      list-style: none;
      padding-left: 0;
      margin: 4px 0 0;
    }

    .next-memo-item {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(15, 23, 42, 0.6);
    }

    .next-memo-label {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      font-size: 12px;
    }

    .next-memo-text {
      white-space: pre-wrap;
      word-break: break-word;
    }

    .next-memo-meta {
      font-size: 10px;
      color: var(--muted);
      margin-left: 20px;
    }

    .next-memo-input {
      width: 100%;
      min-height: 48px;
      resize: vertical;
      background: #020617;
      color: var(--text);
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 6px 8px;
    }

    .btn-ghost-small {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: transparent;
      color: var(--muted);
      font-size: 10px;
      cursor: pointer;
    }

    .btn-ghost-small:hover {
      background: rgba(15, 23, 42, 0.8);
      color: #e5e7eb;
    }

    /* OneDrive box */
    .onedrive-box {
      margin: 10px 0 12px;
      padding: 10px 12px;
      border: 1px solid rgba(255, 255, 255, .10);
      border-radius: 14px;
      background: rgba(0, 0, 0, .18);
    }

    .onedrive-box>summary {
      list-style: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-weight: 700;
      user-select: none;
    }

    .onedrive-box>summary::-webkit-details-marker {
      display: none;
    }

    .onedrive-summary-sub {
      font-weight: 600;
      opacity: .85;
      font-size: 12px;
      padding: 4px 10px;
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: 999px;
      background: rgba(255, 255, 255, .06);
    }

    .onedrive-body {
      margin-top: 10px;
    }

    .onedrive-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .onedrive-grid label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      opacity: .95;
    }

    .onedrive-actions {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .onedrive-hint {
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .05);
      font-size: 12px;
      opacity: .92;
    }

    .onedrive-hint-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }

    .onedrive-hint-row code {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(0, 0, 0, .22);
    }

    .onedrive-hint-sub {
      margin-top: 8px;
      opacity: .9;
      line-height: 1.45;
    }

    .onedrive-status {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(56, 189, 248, 0.3);
      background: rgba(2, 6, 23, 0.6);
      font-size: 11px;
      line-height: 1.5;
    }

    .onedrive-status strong {
      color: var(--accent);
    }

    /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    .tab-nav {
      display: flex;
      gap: 0;
      margin: 0 20px;
      border-bottom: 1px solid var(--border);
    }

    .tab-btn {
      padding: 10px 20px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--muted);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab-btn:hover {
      color: var(--text);
    }

    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ä½“åŠ›ãƒ»ãƒ¡ãƒ³ã‚¿ãƒ«å…¥åŠ›ãƒœã‚¿ãƒ³ */
    .rating-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    .rating-label {
      font-size: 11px;
      color: var(--muted);
      min-width: 60px;
    }

    .rating-btns {
      display: flex;
      gap: 4px;
    }

    .rating-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.8);
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .rating-btn:hover {
      border-color: var(--accent);
      color: var(--text);
    }

    .rating-btn.small {
      width: 20px;
      height: 20px;
      font-size: 10px;
      line-height: 18px;
      padding: 0;
    }

    .rating-btn.selected {
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.4), rgba(34, 197, 94, 0.4));
      border-color: var(--accent);
      color: #fff;
    }

    .rating-clear {
      font-size: 10px;
      color: var(--muted);
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 4px 6px;
    }

    .rating-clear:hover {
      color: var(--text);
    }

    /* è£é¢ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ */
    .future-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      color: var(--muted);
      text-align: center;
      padding: 40px 20px;
    }

    .future-placeholder-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .future-placeholder-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .future-placeholder-text {
      font-size: 13px;
      line-height: 1.6;
      max-width: 400px;
    }
  </style>
</head>

<body>
  <header>
    <h1>ä»Šæ—¥ã®ä¸€æ­©ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <p>ã†ãœã‚“ã®ã€Œä¸€æ­©ã€ã‚’å¯è¦–åŒ–ã—ã¦ã€åã‚Šã‚’è¦‹ã¦æ¬¡ã®ä¸€æ­©ã‚’æ±ºã‚ã‚‹ãŸã‚ã®ã€å€‹äººç”¨ãƒ¢ãƒ‹ã‚¿ã€‚</p>
  </header>

  <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <nav class="tab-nav">
    <button type="button" class="tab-btn active" data-tab="ippo">ä¸€æ­©ãƒ­ã‚°</button>
    <button type="button" class="tab-btn" data-tab="future">æœªæ¥ãƒ©ãƒœ</button>
  </nav>

  <!-- è¡¨é¢ï¼šä¸€æ­©ãƒ­ã‚° -->
  <div id="tabIppo" class="tab-content active">
    <main>
      <!-- å·¦ï¼šä»Šæ—¥ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼ˆè¿½åŠ  â†’ æ—¥åˆ¥ãƒ­ã‚° â†’ æ—¥è¨˜ï¼‰ -->
      <section class="panel" id="leftPanel">

        <!-- ä¸€æ­©ã‚’è¿½åŠ  -->
        <div class="panel-header">
          <div class="panel-title">
            ä¸€æ­©ã‚’è¿½åŠ 
            <span class="badge">ãã®å ´ã§è¿½è¨˜</span>
          </div>
          <small>è¿½åŠ ã—ãŸä¸€æ­©ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã•ã‚Œã€åŒæœŸã•ã‚Œã‚‹ã€‚</small>
        </div>
        <form id="addForm">
          <label>
            <span class="form-note">ä¸€æ­©ã®å†…å®¹</span>
            <textarea id="addText" placeholder="ä¾‹ï¼šã€ã€‡ã€‡ã®ä¼ç”»æ¡ˆã‚’éƒ¨é•·ã«æŠ•ã’ãŸã€ã€å­ä¾›ã¨çš„å½“ã¦ã‚²ãƒ¼ãƒ ã—ãŸã€ã€DXæ¤œå®šã®å‹‰å¼·ã‚’30åˆ†ã‚„ã£ãŸã€ãªã©"></textarea>
          </label>



          <div class="form-row">
            <label>
              æ—¥ä»˜ï¼š
              <input type="date" id="addDate">
            </label>
            <button type="submit" class="primary">ã“ã®ä¸€æ­©ã‚’è¿½åŠ </button>
          </div>
          <div class="form-note">
            â€»ã‚«ãƒ†ã‚´ãƒªã¯æ–‡é¢ã‹ã‚‰è‡ªå‹•æ¨å®šï¼ˆ ä»•äº‹ãƒ»ä¼ç”»ï¼å®¶æ—ãƒ»å­ã©ã‚‚ï¼å¥åº·ãƒ»èº«ä½“ï¼ç’°å¢ƒãƒ»æš®ã‚‰ã—ï¼å­¦ã³ãƒ»æŠ€è¡“ï¼ãŠé‡‘ãƒ»æŠ•è³‡ï¼è¶£å‘³ãƒ»éŠã³ï¼å¿ƒãƒ»ãƒ¡ãƒ³ã‚¿ãƒ«ï¼ãã®ä»– ï¼‰
          </div>
          <div id="addMessage" class="message"></div>
        </form>

        <!-- æ—¥åˆ¥ãƒ­ã‚° -->
        <div class="panel-header" style="margin-top:12px;">
          <div class="panel-title">
            æ—¥åˆ¥ãƒ­ã‚°
            <span class="badge">ä»Šæ—¥ã®ä¸€æ­©ä¸€è¦§</span>
          </div>
          <small>æ—¥ä»˜ã‚’é¸ã¶ã¨ã€ãã®æ—¥ã®ä¸€æ­©ãƒ»å‰é€²ç‡ãƒ»ã‚«ãƒ†ã‚´ãƒªåˆ†å¸ƒãŒè¦‹ãˆã‚‹</small>
        </div>

        <div class="daily-header">
          <div>
            <div class="daily-title">
              <span id="selectedDateLabel">-</span> ã®ä¸€æ­©
            </div>
            <div class="daily-sub">
              <span id="dailyCountLabel">0ä»¶</span>
            </div>
          </div>
          <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
            <!-- B-3: æ—¥æ¬¡ãƒ¡ãƒ³ã‚¿ãƒ«å…¥åŠ› -->
            <div class="rating-group"
              style="margin:0; background:rgba(0,0,0,0.2); padding:2px 8px; border-radius:999px;">
              <span class="rating-label" style="font-size:10px;">ä»Šæ—¥ã®ãƒ¡ãƒ³ã‚¿ãƒ«:</span>
              <div class="rating-btns" id="dailyMentalBtns">
                <button type="button" class="rating-btn small" data-value="1">1</button>
                <button type="button" class="rating-btn small" data-value="2">2</button>
                <button type="button" class="rating-btn small" data-value="3">3</button>
                <button type="button" class="rating-btn small" data-value="4">4</button>
                <button type="button" class="rating-btn small" data-value="5">5</button>
              </div>
              <button type="button" class="rating-clear" id="dailyMentalClear" style="font-size:10px;">Ã—</button>
            </div>
            <select id="dateSelect"></select>
            <div class="score-pill">
              <span>å‰é€²ç‡</span>
              <strong id="dailyScore">0.0</strong><span>%</span>
            </div>
          </div>
        </div>

        <div id="dailyTableWrap">
          <table>
            <thead>
              <tr>
                <th style="width: 38px;">å…¥åŠ›æ™‚é–“</th>
                <th>ä¸€æ­©ã®å†…å®¹</th>
                <th style="width: 110px;">ã‚«ãƒ†ã‚´ãƒª</th>
                <th style="width: 84px;">ä¸€æ­©æ™‚é–“å¸¯</th>
                <th style="width: 52px;">é‡è¦</th>
              </tr>
            </thead>
            <tbody id="dailyTbody"></tbody>
          </table>
        </div>
        <div id="noDataDaily" class="empty-state" style="display:none;">
          ã¾ã ä¸€æ­©ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®ã€Œä¸€æ­©ã‚’è¿½åŠ ã€ã‹ã‚‰ä¸€æ­©ã‚’è¿½åŠ ã™ã‚‹ã‹ã€å³å´ã®ã€Œä¸€æ­©ãƒ­ã‚°CSVã‚’èª­ã¿è¾¼ã‚€ã€ã‹ã‚‰å–ã‚Šè¾¼ã‚“ã§ãã ã•ã„ã€‚
        </div>

        <!-- æ—¥è¨˜ã‚¨ãƒªã‚¢ -->
        <div class="panel-header" style="margin-top:12px;">
          <div class="panel-title">
            æ—¥è¨˜
            <span class="badge">é¸æŠã—ãŸæ—¥ã®ä¸€æ­©ã‹ã‚‰è‡ªå‹•ç”Ÿæˆ</span>
          </div>
          <small>ãƒ†ã‚­ã‚¹ãƒˆã¯è‡ªç”±ã«ç·¨é›†ã—ã¦ã€æ—¥è¨˜ã‚¢ãƒ—ãƒªãªã©ã«ã‚³ãƒ”ãƒšã§ãã‚‹ã€‚</small>
        </div>
        <div>
          <div class="form-row" style="justify-content:flex-end; margin-bottom:4px;">
            <button type="button" id="regenerateDiaryBtn" class="btn-ghost">æ—¥è¨˜ã‚’å†ç”Ÿæˆ</button>
            <button type="button" id="copyDiaryBtn" class="btn-ghost">æ—¥è¨˜ã‚’ã‚³ãƒ”ãƒ¼</button>
          </div>
          <textarea id="diaryOutput" placeholder="ã“ã“ã«ã€é¸æŠä¸­ã®æ—¥ä»˜ã®ä¸€æ­©ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸæ—¥è¨˜ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚"></textarea>
          <div id="diaryMessage" class="form-note"></div>
        </div>
      </section>

      <!-- å³ï¼šéå»ï¼†æœªæ¥ã‚¾ãƒ¼ãƒ³ï¼ˆCSVãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ»æ¬¡ã®ä¸€æ­©ï¼‰ -->
      <section class="panel">

        <!-- CSVèª­ã¿è¾¼ã¿ï¼†ãƒªã‚»ãƒƒãƒˆ -->
        <div class="top-row">
          <div class="file-input-wrap">
            <label for="csvInput">ä¸€æ­©ãƒ­ã‚°CSVã‚’èª­ã¿è¾¼ã‚€</label>
            <input type="file" id="csvInput" accept=".csv,text/csv">
            <span id="fileStatus">ã¾ã CSVã¯èª­ã¿è¾¼ã‚“ã§ã„ã¾ã›ã‚“</span>
          </div>
          <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <span class="pill">OneDriveåŒæœŸ + ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥</span>
            <button type="button" id="resetButton" class="btn-ghost">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>

        <!-- OneDrive -->
        <details class="onedrive-box" id="onedriveDetails">
          <summary>OneDriveè¨­å®š <span class="onedrive-summary-sub" id="odStatus">æœªæ¥ç¶š</span></summary>
          <div class="onedrive-body">
            <div class="onedrive-grid">
              <label>Client IDï¼ˆã‚¢ãƒ—ãƒªIDï¼‰
                <input id="odClientId" type="text" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                  autocomplete="off" />
              </label>
              <label>Tenantï¼ˆä»»æ„ï¼‰
                <input id="odTenant" type="text" placeholder="common / organizations / consumers / ãƒ†ãƒŠãƒ³ãƒˆID"
                  autocomplete="off" />
              </label>
              <label>Redirect URIï¼ˆå¤‰æ›´å¯ï¼‰
                <input id="odRedirectInput" type="text" placeholder="http://localhost:5500/" autocomplete="off" />
              </label>
              <label>ä¿å­˜å…ˆãƒ‘ã‚¹ï¼ˆAppFolderå†…ï¼‰
                <input id="odFilePath" type="text" placeholder="/Apps/IppoDashboard/ippo_data.json"
                  autocomplete="off" />
              </label>
            </div>

            <div class="onedrive-actions">
              <button class="btn-ghost" id="odSave" type="button">ä¿å­˜</button>
              <button class="btn-ghost" id="odClear" type="button">ã‚¯ãƒªã‚¢</button>
              <button class="btn-ghost" id="odSignIn" type="button">ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
              <button class="btn-ghost" id="odSignOut" type="button" disabled>ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ</button>
              <button class="btn-ghost" id="odSyncNow" type="button" disabled>ä»Šã™ãåŒæœŸ</button>
            </div>

            <div class="onedrive-actions">
              <button class="btn-ghost" id="odExport" type="button">JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
              <label class="btn-ghost" for="odImportInput" style="cursor:pointer;">JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                <input id="odImportInput" type="file" accept="application/json" style="display:none;" />
              </label>
            </div>

            <div class="onedrive-status" id="odSyncStatus">
              <div>åŒæœŸçŠ¶æ…‹: <strong id="odSyncState">æœªåŒæœŸ</strong></div>
              <div>æœ€çµ‚åŒæœŸ: <span id="odLastSync">-</span></div>
              <div>æœªé€ä¿¡ä»¶æ•°: <span id="odPendingCount">0</span></div>
              <div>ã‚¨ãƒ©ãƒ¼: <span id="odLastError">-</span></div>
            </div>

            <div class="onedrive-hint">
              <div class="onedrive-hint-row">
                <span>æ¨å¥¨Redirect</span>
                <code id="odRedirectUri"></code>
                <button class="btn-ghost" id="odCopyRedirect" type="button">ã‚³ãƒ”ãƒ¼</button>
              </div>
              <div class="onedrive-hint-sub">
                ä¿å­˜å…ˆã¯ <b>ã‚¢ãƒ—ãƒªå°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆAppFolderï¼‰</b>ã€‚æ—¢å®šã¯ <code>/Apps/IppoDashboard/ippo_data.json</code>ã€‚
                ï¼ˆæ¨©é™: <code>Files.ReadWrite.AppFolder</code>ï¼‰
              </div>
            </div>

            <div class="onedrive-hint small">
              é‡è¦: <code>file://</code> ç›´é–‹ãã ã¨èªè¨¼ãŒå‹•ã‹ãªã„ã€‚Live Server ç­‰ã§ <code>http://localhost</code> ã§é–‹ãã“ã¨ã€‚
            </div>
          </div>
        </details>

        <!-- Debug Log Area -->
        <details class="onedrive-box">
          <summary>Debug Logs</summary>
          <textarea id="debugLogArea"
            style="width:100%; height:120px; background:#111; color:#0f0; font-family:monospace; font-size:10px; border:none; padding:8px;"
            readonly></textarea>
        </details>

        <!-- ãƒ¡ãƒˆãƒªã‚¯ã‚¹ -->
        <div class="panel-header">
          <div class="panel-title">
            ãƒ¡ãƒˆãƒªã‚¯ã‚¹
            <span class="badge">å…¨ä½“ã‚µãƒãƒª</span>
          </div>
          <small id="metricsSubtitle"></small>
        </div>
        <div class="metrics-row">
          <div class="metric-card">
            <div class="metric-label">ç´¯è¨ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°</div>
            <div class="metric-value" id="metricTotal">0</div>
            <div class="metric-sub">ã“ã‚Œã¾ã§ã®ã€Œä¸€æ­©ã€ã®ç·æ•°</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">ä»Šé€±ã®ç´¯è¨ˆ</div>
            <div class="metric-value" id="metricWeekly">0</div>
            <div class="metric-sub" id="metricWeeklyRange">-</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">ä»Šæœˆã®ç´¯è¨ˆ</div>
            <div class="metric-value" id="metricMonthly">0</div>
            <div class="metric-sub">æœ€æ–°ã®æ—¥ä»˜ã®æœˆãƒ™ãƒ¼ã‚¹</div>
          </div>
        </div>
        <div class="form-row" style="justify-content:flex-end; margin-bottom:8px;">
          <button type="button" id="exportMonthlyBtn" class="btn-ghost">æœˆæ¬¡ã‚µãƒãƒªCSV</button>
          <button type="button" id="exportAllBtn" class="btn-ghost">å…¨ä»¶CSV</button>
        </div>

        <!-- ã‚«ãƒ†ã‚´ãƒªåˆ†å¸ƒ -->
        <div class="panel-header" style="margin-top:4px;">
          <div class="panel-title">
            ã‚«ãƒ†ã‚´ãƒªåˆ†å¸ƒ
            <span class="badge">ã“ã“æ•°æ—¥ã®åã‚Š</span>
          </div>
          <small>æœ€è¿‘7æ—¥é–“ã‚’å¯¾è±¡ã«ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®æœ¬æ•°ã‚’é›†è¨ˆ</small>
        </div>
        <div id="categoryBars"></div>
        <div id="noCategory" class="empty-state" style="display:none;">
          ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã®ã§ã€ã‚«ãƒ†ã‚´ãƒªåˆ†å¸ƒã¯ã¾ã å‡ºã›ã¾ã›ã‚“ã€‚
        </div>

        <!-- æ¬¡ã®ä¸€æ­©ãƒ¡ãƒ¢ï¼ˆæ‰‹å‹•ï¼‰ -->
        <div class="panel-header" style="margin-top:12px;">
          <div class="panel-title">
            æ¬¡ã®ä¸€æ­©ãƒ¡ãƒ¢
            <span class="badge">ã‚ã¨ã§ã‚„ã‚ŠãŸã„ã“ã¨ç½®ãå ´</span>
          </div>
          <small>ã€Œä»Šæ—¥ã¯ä½“åŠ›ãªã„ã‘ã©ã€ãã®ã†ã¡ã‚„ã‚ŠãŸã„ã€ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ã‚¹ãƒˆãƒƒã‚¯ã€‚çµ‚ã‚ã£ãŸã‚‰ãƒã‚§ãƒƒã‚¯ã—ã¦æ¶ˆã™ã€‚</small>
        </div>

        <form id="nextMemoForm">
          <label>
            <span class="form-note">ã‚„ã‚ŠãŸã„ã‘ã©ä»Šæ—¥ã¯ã‚„ã‚‰ãªã„ä¸€æ­©ãƒ¡ãƒ¢</span>
            <textarea id="nextMemoInput" class="next-memo-input"
              placeholder="ä¾‹ï¼šã€ä¸€æ­©ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®â—¯â—¯æ©Ÿèƒ½ã‚’è©¦ã™ã€ã€â—‹â—‹ã•ã‚“ã«ã“ã®å‰ã®ä¼ç”»ã®åå¿œã‚’èãã€ãªã©"></textarea>
          </label>
          <div class="form-row" style="justify-content:flex-end;">
            <button type="submit" class="btn-ghost">ãƒ¡ãƒ¢ã‚’è¿½åŠ </button>
          </div>
        </form>

        <div id="nextMemoEmpty" class="empty-state">
          ã¾ã ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œã„ã¤ã‹ã‚„ã‚‹ä¸€æ­©ã€ã‚’ã“ã“ã«ç½®ã„ã¦ãŠã‘ã‚‹ã€‚
        </div>
        <ul id="nextMemoList" class="next-memo-list"></ul>

      </section>
    </main>
  </div><!-- /tabIppo -->

  <!-- è£é¢ï¼šæœªæ¥ãƒ©ãƒœ -->
  <div id="tabFuture" class="tab-content">
    <main style="padding: 12px 20px 20px;">
      <div class="lab-grid">

        <!-- 1. Mental Rhythm (æ—§ Energy Flow) - Full Width -->
        <div class="lab-card span-full" style="min-height: 320px;">
          <h3 class="lab-title">
            <span>Mental Rhythm</span>
            <span class="pill">30-Day Trend</span>
          </h3>
          <div class="lab-chart-wrap">
            <canvas id="chartFlow"></canvas>
          </div>
        </div>

        <!-- 2. Activity Balance (æ—§ Cross TOD) - 1/3 -->
        <div class="lab-card span-1">
          <h3 class="lab-title">
            <span>Activity Balance</span>
            <span class="pill">Time x Category</span>
          </h3>
          <div class="lab-chart-wrap">
            <canvas id="chartCrossTod"></canvas>
          </div>
        </div>

        <!-- 3. Category Radar - 1/3 -->
        <div class="lab-card span-1">
          <h3 class="lab-title">
            <span>Interest Balance</span>
            <span class="pill">Category Dist.</span>
          </h3>
          <div class="lab-chart-wrap">
            <canvas id="chartRadar"></canvas>
          </div>
        </div>

        <!-- 4. Keyword Galaxy - 1/3 -->
        <div class="lab-card span-1">
          <h3 class="lab-title">
            <span>Keyword Galaxy</span>
            <span class="pill">Trends</span>
          </h3>
          <div class="lab-chart-wrap">
            <canvas id="chartKeywords"></canvas>
          </div>
        </div>

        <!-- 5. Great Steps Gallery - Full Width -->
        <div class="lab-card span-full"
          style="border-color: rgba(251, 191, 36, 0.3); background: rgba(251, 191, 36, 0.05);">
          <h3 class="lab-title" style="color: #fbbf24;">
            <span>Great Steps Gallery</span>
            <span class="pill" style="border-color: #fbbf24; color: #fbbf24;">Hall of Fame ğŸ†</span>
          </h3>
          <div id="greatStepsList"
            style="max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding-right: 4px;">
            <!-- JSã§æ³¨å…¥ -->
          </div>
        </div>

      </div>

      <!-- 6. AI Bridge (Future Simulation) -->
      <div class="lab-card span-full"
        style="border-color: rgba(217, 70, 239, 0.4); background: rgba(217, 70, 239, 0.05);">
        <h3 class="lab-title" style="color: #d946ef;">
          <span>AI Bridge Implementation</span>
          <span class="pill" style="border-color: #d946ef; color: #d946ef;">SEED Phase 4</span>
        </h3>

        <div class="bridge-container" style="display: flex; flex-direction: column; gap: 16px;">
          <!-- Step 1: Export -->
          <div class="bridge-step">
            <div style="font-size:12px; opacity:0.7; margin-bottom:4px;">STEP 1: Generate Context</div>
            <p style="font-size:13px; margin:0 0 8px;">éå»ãƒ­ã‚°ã¨æœªæ¥äºˆæ¸¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã€ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚</p>
            <button id="btnBridgeExport" class="btn-primary" type="button"
              style="background:var(--bg-soft); border:1px solid #d946ef; color:#d946ef; width:100%;">
              ğŸ“‹ Copy Simulation Context
            </button>
          </div>

          <!-- Step 2: Import -->
          <div class="bridge-step">
            <div style="font-size:12px; opacity:0.7; margin-bottom:4px;">STEP 2: Visualize Future</div>
            <p style="font-size:13px; margin:0 0 8px;">LLMã‹ã‚‰ã®JSONå‡ºåŠ›ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
            <textarea id="bridgeInput" placeholder='Paste JSON here... (e.g. {"persona_solid": ...})'
              style="width:100%; height:80px; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:var(--text); padding:8px; border-radius:4px; font-size:12px; font-family:monospace;"></textarea>

            <div style="margin-top:6px; margin-bottom: 2px;">
              <label
                style="font-size:11px; color:var(--muted); display:inline-flex; align-items:center; cursor:pointer;">
                <input type="checkbox" id="chkDisableLimit" style="margin-right:4px;"> 1æ—¥1å›åˆ¶é™ã‚’ç„¡åŠ¹åŒ– (åŒæ—¥ãƒªãƒˆãƒ©ã‚¤ç”¨)
              </label>
            </div>
            <button id="btnBridgeImport" class="btn-primary" type="button"
              style="background:#d946ef; color:white; width:100%; margin-top:8px;">
              ğŸ”® Visualize Future
            </button>
          </div>

          <!-- Result Area -->
          <div id="futureCardsContainer"
            style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-top:8px; display:none;">
            <!-- JS Injected -->
          </div>
        </div>
      </div>
  </div>
  </div><!-- /tabFuture -->

  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <script>
    // --- Tab Switching Logic ---
    function initTabs() {
      const tabs = document.querySelectorAll(".tab-btn");
      tabs.forEach(btn => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.tab; // 'ippo' or 'future'
          switchTab(target);
        });
      });
    }

    function switchTab(tabName) {
      // 1. Update buttons
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tabName);
      });

      // 2. Update content
      document.getElementById("tabIppo").classList.toggle("active", tabName === "ippo");
      document.getElementById("tabFuture").classList.toggle("active", tabName === "future");

      // 3. Init Lab if needed
      if (tabName === "future") {
        initFutureLab();
      }
    }

    let isLabInitialized = false;
    function initFutureLab() {
      if (isLabInitialized) return;
      console.log("Initializing Future Lab...");

      isLabInitialized = true;

      // éåŒæœŸã§æç”»ï¼ˆUIãƒ–ãƒ­ãƒƒã‚¯é˜²æ­¢ï¼‰
      setTimeout(() => {
        renderRadarChart();
        renderFlowChart();
        renderCrossTodChart();
        renderKeywordChart();
        renderGreatStepsGallery();
        initBridgeEvents(); // AI Bridge
        initStoryMode(); // Story ModeçŠ¶æ…‹å¾©å…ƒ

        // ä¿å­˜æ¸ˆã¿ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å¾©å…ƒï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–ï¼‰
        const sims = (dataCache.simulations || []).filter(s => !s.deleted);
        if (sims.length > 0) {
          // æœ€æ–°ã®ä¸–ç•Œç·šã‚«ãƒ¼ãƒ‰ã‚’è‡ªå‹•å¾©å…ƒ
          const latestSim = sims[0];
          if (latestSim.result) {
            renderFutureCards(latestSim.result, latestSim.id);
            document.getElementById("futureCardsContainer").style.display = "grid";
          }
        }
        // SIMULATION HISTORY ã‚’å¸¸ã«è¡¨ç¤º
        renderSimulationHistory();
      }, 100);
    }

    // DEBUG: ãƒ­ã‚°è¡¨ç¤ºç”¨
    function appendDebugLog(msg) {
      const el = document.getElementById("debugLogArea");
      if (!el) return;
      const time = new Date().toLocaleTimeString();
      el.value += `[${time}] ${msg}\n`;
      el.scrollTop = el.scrollHeight;
    }

    // --- Chart Implementations ---

    function renderGreatStepsGallery() {
      const el = document.getElementById("greatStepsList");
      if (!el) return;
      el.innerHTML = "";

      const entries = getActiveEntries().filter(e => e.starred);
      if (entries.length === 0) {
        el.innerHTML = `<div style="padding:20px; text-align:center; color:#fbbf24; opacity:0.7;">ã¾ã ã€Œå‰å¤§ãªä¸€æ­©ã€ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>æ—¥å ±ãƒ†ãƒ¼ãƒ–ãƒ«ã®â˜†ã‚’æŠ¼ã—ã¦ç™»éŒ²ã—ã‚ˆã†ï¼</div>`;
        return;
      }

      // æ–°ã—ã„é †
      entries.sort((a, b) => b.ts - a.ts);

      entries.forEach(e => {
        const row = document.createElement("div");
        row.style.padding = "8px 12px";
        row.style.background = "rgba(0,0,0,0.2)";
        row.style.borderRadius = "8px";
        row.style.borderLeft = "3px solid #fbbf24";

        const dateStr = getRecordTime(e).split(" ")[0]; // YYYY-MM-DD

        row.innerHTML = `
          <div style="font-size:10px; opacity:0.7; margin-bottom:2px; display:flex; justify-content:space-between;">
            <span>${dateStr}</span>
            <span style="color:#fbbf24;">${e.category}</span>
          </div>
          <div style="font-size:13px;">${e.text}</div>
        `;
        el.appendChild(row);
      });
    }

    // --- AI Bridge Logic (SEED v5) ---

    function initBridgeEvents() {
      document.getElementById("btnBridgeExport")?.addEventListener("click", copySimulationContext);
      document.getElementById("btnBridgeImport")?.addEventListener("click", importSimulationResult);

      // Disable Limit Checkbox Logic
      const chk = document.getElementById("chkDisableLimit");
      if (chk) {
        // Restore state
        chk.checked = localStorage.getItem("ippo_disable_limit") === "true";
        // Save state
        chk.addEventListener("change", (e) => {
          localStorage.setItem("ippo_disable_limit", e.target.checked);
        });
      }
    }

    function buildPreviousSimSummary(sim) {
      if (!sim || !sim.result) return null;
      const r = sim.result;

      // v5 check
      const isV5 = r.worldline_baseline && r.worldline_leap && r.worldline_guardrail;
      // æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³(v4)ã®å ´åˆã¯ç°¡æ˜“è¡¨ç¤º
      if (!isV5) return "å‰å›ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³(v4)ã§ã™ã€‚";

      const dateStr = new Date(sim.createdAt).toLocaleDateString("ja-JP");

      // Helper to extract 1w/6m outcomes
      const getOutcomes = (wl) => {
        if (!wl || !wl.roadmap) return "";
        const w1 = wl.roadmap.find(x => x.horizon === "1w")?.outcome || "";
        const m6 = wl.roadmap.find(x => x.horizon === "6m")?.outcome || "";
        return `1w:${w1.slice(0, 30)}... / 6m:${m6.slice(0, 30)}...`;
      };

      return `
å‰å›ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (${dateStr}):
- Baseline: ã€Œ${r.worldline_baseline.title}ã€â†’ ${getOutcomes(r.worldline_baseline)}
- Leap: ã€Œ${r.worldline_leap.title}ã€â†’ ${getOutcomes(r.worldline_leap)}
- Guardrail: ã€Œ${r.worldline_guardrail.title}ã€â†’ ${getOutcomes(r.worldline_guardrail)}
- rubric_score: B:${r.worldline_baseline.rubric_score} / L:${r.worldline_leap.rubric_score} / G:${r.worldline_guardrail.rubric_score}
`.trim();
    }

    async function copySimulationContext() {
      const entries = getActiveEntries();
      const sorted = entries.slice().sort((a, b) => b.ts - a.ts);

      // ç›´è¿‘90æ—¥ (3ãƒ¶æœˆ)
      const windowMs = 90 * 24 * 60 * 60 * 1000;
      const border = Date.now() - windowMs;

      let recent = sorted.filter(e => e.ts >= border);

      // ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã™ãã‚‹å ´åˆã®æœ€ä½ä¿è¨¼ (Min 30)
      if (recent.length < 30) {
        recent = sorted.slice(0, Math.min(30, sorted.length));
      }

      // InputDigestç”Ÿæˆ
      const categoryCount = {};
      const keywordCount = {};

      const todMap = { "morning": "ğŸŒ…", "afternoon": "â˜€ï¸", "day": "â˜€ï¸", "night": "ğŸŒ™" };
      const todStats = { "morning": 0, "afternoon": 0, "day": 0, "night": 0 };
      let todTotal = 0;

      recent.forEach(e => {
        const cat = e.category || "ãã®ä»–";
        categoryCount[cat] = (categoryCount[cat] || 0) + 1;
        // ç°¡æ˜“ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º
        const words = (e.text || "").split(/[\sã€ã€‚,]+/).filter(w => w.length >= 2 && w.length <= 10);
        words.forEach(w => {
          keywordCount[w] = (keywordCount[w] || 0) + 1;
        });

        // TODé›†è¨ˆ
        if (e.tod && Array.isArray(e.tod)) {
          e.tod.forEach(t => {
            if (todStats[t] !== undefined) {
              todStats[t]++;
              todTotal++;
            }
          });
        }
      });

      const topCategories = Object.entries(categoryCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([category, count]) => ({ category, count }));

      const topKeywords = Object.entries(keywordCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([keyword, count]) => ({ keyword, count }));

      // TOD Contextç”Ÿæˆ
      let todContext = "No time-of-day tags found.";
      if (todTotal > 0) {
        todContext = Object.entries(todStats)
          .filter(([k, v]) => v > 0)
          .map(([k, v]) => `- ${k}: ${Math.round((v / todTotal) * 100)}% (${v}å›)`)
          .join("\n");
      }

      const dateRange = recent.length > 0 ? {
        from: recent[recent.length - 1].date,
        to: recent[0].date
      } : { from: "", to: "" };

      // æ—¥æ¬¡ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡º
      const dailyMentalList = [];
      const visitedDates = new Set();
      recent.forEach(e => {
        if (!e.date || visitedDates.has(e.date)) return;
        visitedDates.add(e.date);
        const state = (dataCache.dailyStates || {})[e.date];
        if (state && state.mental) {
          dailyMentalList.push({ date: e.date, mental: state.mental });
        }
      });
      // æ—¥ä»˜é™é † -> æ˜‡é †ã«ç›´ã—ã¦æ™‚ç³»åˆ—ã§è¦‹ã‚„ã™ãã™ã‚‹
      dailyMentalList.sort((a, b) => a.date.localeCompare(b.date));

      const dailyMentalContext = dailyMentalList.length > 0
        ? dailyMentalList.map(d => `- ${d.date}: Mental Lv.${d.mental}`).join("\n")
        : "No daily mental records available.";

      const userLogs = recent.map(e => {
        // TODæƒ…å ±ã‚’ã‚¢ã‚¤ã‚³ãƒ³+ãƒ†ã‚­ã‚¹ãƒˆã§ä»˜ä¸ã—ã¦çµã³ã¤ãã‚’å¼·åŒ–
        const tods = (e.tod || []).map(k => {
          const icon = todMap[k] || "";
          return icon ? `${icon}(${k})` : "";
        }).join(" ");
        const todStr = tods ? ` ${tods}` : "";
        return `${e.date}${todStr} [${e.category}]: ${e.text}`;
      }).join("\n");

      // å‰å›ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã®å–å¾—
      const sims = (dataCache.simulations || []).filter(s => !s.deleted);
      const previousSim = sims.length > 0 ? sims[0] : null;
      const previousSummary = previousSim ? buildPreviousSimSummary(previousSim) : null;

      // å·®åˆ†ãƒ­ã‚°ï¼ˆå‰å›ä½œæˆæ—¥ä»¥é™ï¼‰
      let newLogsContext = "ï¼ˆåˆå›ã®ãŸã‚æ¯”è¼ƒãªã—ï¼‰";
      if (previousSim) {
        const prevTime = previousSim.createdAt;
        // æ–°ã—ã„é †ã«ä¸¦ã‚“ã§ã„ã‚‹ã®ã§ã€prevTimeã‚ˆã‚Šæ–°ã—ã„ã‚‚ã®ã‚’æŠ½å‡º
        const newLogs = recent.filter(e => e.ts > prevTime);
        if (newLogs.length > 0) {
          newLogsContext = newLogs.map(e => `- ${e.date} [${e.category}]: ${e.text.slice(0, 50)}...`).join("\n");
        } else {
          newLogsContext = "ï¼ˆå‰å›ä»¥é™ã®æ–°è¦ãƒ­ã‚°ãªã—ï¼‰";
        }
      }

      const prompt = `
# SEED v5 Simulation Request (v2.5.1 tuned)

ã‚ãªãŸã¯ã€Œæœªæ¥ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ã‚¸ãƒ³ã€ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éå»ãƒ­ã‚°ï¼ˆè¦³æ¸¬ï¼‰ã«ã‚‚ã¨ã¥ãã€3ã¤ã®ä¸–ç•Œç·šï¼ˆBaseline / Leap / Guardrailï¼‰ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚
**ã€Œæ´»å‹•æ™‚é–“å¸¯ï¼ˆTime of Dayï¼‰ã€ã¨ã€Œè¡Œå‹•å†…å®¹ã€ã®ç›¸é–¢**ã«ã‚‚æ³¨ç›®ã—ã€ç”Ÿæ´»ãƒªã‚ºãƒ ã®è¦³ç‚¹ã‹ã‚‰ã‚‚åˆ†æã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

## å¤§å‰æï¼ˆå®ˆã‚‹ãƒ«ãƒ¼ãƒ«ï¼‰
- å ã„åŒ–ç¦æ­¢ï¼šæœªæ¥ã¯ã€Œå½“ã¦ã‚‹ã€ã®ã§ã¯ãªãã€Œé¸æŠè‚¢ã‚’å¢—ã‚„ã™ã€ãŸã‚ã®æœªæ¥åœ°å›³
- ä¸–ç•Œç·šã¯å›ºå®š3æœ¬ï¼ˆè¿·å®®åŒ–é˜²æ­¢ï¼‰
  - Baselineï¼ˆç¾çŠ¶å»¶é•·ï¼‰
  - Leapï¼ˆ10Xé£›èºï¼‰
  - Guardrailï¼ˆå´©ã‚Œå›é¿ / é€ƒèµ°æ­“è¿ / å›å¾©ã®è¶³å ´ï¼‰
- åŒ»ç™‚ãƒ»è¨ºæ–­ã®æ–­å®šã¯ç¦æ­¢
- ãƒ­ã‚°ã«ç„¡ã„æ–‡è„ˆã‚’æé€ ã—ãªã„ï¼ˆevidenceã¯ãƒ­ã‚°å¼•ç”¨ãƒ™ãƒ¼ã‚¹ï¼‰
- ææ€–è¨´æ±‚ã¯ç¦æ­¢ï¼ˆç ´æ»…/æ‰‹é…ã‚Œ/æœ€æ‚ª ãªã©ã®ç…½ã‚Šèªã‚’ä½¿ã‚ãªã„ï¼‰
- å‡ºåŠ›ã¯JSONã®ã¿ï¼ˆä½™è¨ˆãªæ–‡ç« ã¯ç¦æ­¢ï¼‰

## Context (User Logs & Optional States)
æœŸé–“: ${dateRange.from} ã€œ ${dateRange.to}
ä»¶æ•°: ${recent.length}ä»¶

Top Categories:
${topCategories.map(c => `- ${c.category}: ${c.count}ä»¶`).join("\n")}

Top Keywords:
${topKeywords.map(k => `- ${k.keyword}: ${k.count}å›`).join("\n")}

Daily Mental (optional, 1=Low, 5=High, æœªå…¥åŠ›ã¯ä¸æ˜ã¨ã—ã¦æ‰±ã†):
${dailyMentalContext}

Time-of-day tags (optional, morning/afternoon/night ã®å‰²åˆã€‚ç„¡ã„ãªã‚‰ä¸æ˜):
${todContext}

--- éå»ãƒ­ã‚°ï¼ˆè¦³æ¸¬ï¼‰ ---
${userLogs}
--- ã“ã“ã¾ã§ ---

## Previous Simulationï¼ˆå‰å›ã¨ã®æ¯”è¼ƒç”¨ï¼‰
${previousSummary || "ï¼ˆéå»ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰"}

### å‰å›ã‹ã‚‰ä»Šå›ã¾ã§ã«è¿½åŠ ã•ã‚ŒãŸãƒ­ã‚°
${newLogsContext}

æŒ‡ç¤º: å‰å›ã®äºˆæ¸¬ã¨ä»Šå›ã®ãƒ­ã‚°å·®åˆ†ã‚’è¸ã¾ãˆã€è»Œé“ãŒã©ã†å¤‰ã‚ã£ãŸã‹ã‚’ \`meta.trajectory_shift\` ã«1-2æ–‡ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
ï¼ˆä¾‹ï¼šã€Œå‰å›ã®Baselineã§ã¯ã€‡ã€‡ã‚’æ‡¸å¿µã—ã¦ã„ãŸãŒã€ã€‡ã€‡ã®å®Ÿè·µã«ã‚ˆã‚ŠLeapå¯„ã‚Šã®è»Œé“ã¸ä¿®æ­£ã•ã‚ŒãŸã€ãªã©ï¼‰

## Self-Rubric Scoringï¼ˆå¿…é ˆãƒ—ãƒ­ã‚»ã‚¹ãƒ»å³å®ˆï¼‰

å„ä¸–ç•Œç·šã‚’ä»¥ä¸‹6è¦³ç‚¹ã§æ¡ç‚¹ã—ã€åˆè¨ˆ90ç‚¹ä»¥ä¸Šã«ãªã‚‹ã¾ã§å†…éƒ¨ã§ä¿®æ­£ã‚’ç¹°ã‚Šè¿”ã—ã¦ãã ã•ã„ã€‚
**90ç‚¹æœªæº€ã®ä¸–ç•Œç·šã¯å‡ºåŠ›ç¦æ­¢ã€‚** å†…éƒ¨ã§ä¿®æ­£ã—ã¦ã‹ã‚‰å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚

| # | è¦³ç‚¹                 | é…ç‚¹ | åŸºæº–                                                   |
|---|----------------------|------|--------------------------------------------------------|
| 1 | Consistency          | 20ç‚¹ | ãƒ­ã‚°ã®å‚¾å‘ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ææ¡ˆã®æ–¹å‘ãŒä¸€è‡´ã—ã¦ã„ã‚‹         |
| 2 | Causality            | 20ç‚¹ | micro_steps â†’ roadmapã®å› æœãŒè«–ç†çš„ã«é€šã‚‹               |
| 3 | Actionability        | 15ç‚¹ | å…¨micro_stepsãŒ15åˆ†ä»¥å†…ã§ç€æ‰‹å¯èƒ½ï¼ˆã€Œæ¤œè¨ã™ã‚‹ã€ã¯ä¸å¯ï¼‰ |
| 4 | Asset Leverage       | 15ç‚¹ | asset_stepsãŒå†åˆ©ç”¨å¯èƒ½ãªå…·ä½“çš„å½¢å¼ã«ãªã£ã¦ã„ã‚‹         |
| 5 | Guardrail Sanity     | 15ç‚¹ | GuardrailãŒå›å¾©ãƒ»é€ƒèµ°ã®è¶³å ´ã¨ã—ã¦å®Ÿéš›ã«æ©Ÿèƒ½ã™ã‚‹         |
| 6 | Evidence Grounding   | 15ç‚¹ | å…¨evidenceãŒãƒ­ã‚°ã‹ã‚‰ç›´æ¥å¼•ç”¨ã§ãã‚‹                       |

rubric_score = 6è¦³ç‚¹ã®åˆè¨ˆï¼ˆ/100ï¼‰
rubric_reason = æœ€ã‚‚ä½ã„è¦³ç‚¹å + æ”¹å–„ã—ãŸå†…å®¹ï¼ˆ1è¡Œï¼‰
rubric_detail = { consistency: ç‚¹, causality: ç‚¹, actionability: ç‚¹, asset_leverage: ç‚¹, guardrail_sanity: ç‚¹, evidence_grounding: ç‚¹ }

## ä¸–ç•Œç·šç‹¬ç«‹æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆå¿…é ˆï¼‰

3ã¤ã®ä¸–ç•Œç·šï¼ˆBaseline / Leap / Guardrailï¼‰ã®micro_stepsã«é‡è¤‡ãŒ30%ä»¥ä¸Šã‚ã‚Œã°ä½œã‚Šç›´ã™ã“ã¨ã€‚
å„ä¸–ç•Œç·šã¯ç•°ãªã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãƒ»æˆ¦ç•¥ã‚’ç¤ºã™ã“ã¨ã€‚

## å‡ºåŠ›è¨€èª

title, narrative, micro_steps, roadmap, asset_steps, risks, guardrails, evidence, rubric_reason ã¯å…¨ã¦æ—¥æœ¬èªã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
ã‚­ãƒ¼åã®ã¿è‹±èªã€‚

## JSON Output Schema
æœ€çµ‚å‡ºåŠ›ã¯ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã‚’ Markdown ã® \`\`\`json ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§å›²ã‚“ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
ä»¶æ•°ãƒ«ãƒ¼ãƒ«ã¯å³å®ˆã€‚æ–‡å­—åˆ—ã®åŸ‹ã‚è‰ï¼ˆ"..."ï¼‰ã¯ç¦æ­¢ã€‚

\`\`\`json
{
  "meta": {
    "version": "SEED_v5",
    "generated_at": "YYYY-MM-DD",
    "time_horizon_days": 180,
    "notes": "ä»®èª¬ã€‚æœªæ¥ã¯é¸æŠè‚¢ã‚’å¢—ã‚„ã™ãŸã‚ã®åœ°å›³ã€‚",
    "trajectory_shift": "å‰å›æ¯”ã§ã®è»Œé“å¤‰åŒ–ã‚’1-2æ–‡ã§ï¼ˆâ€»å¤‰åŒ–ãŒãªã„å ´åˆã¯ã€Œç‰¹ã«ãªã—ã€ã¨æ˜è¨˜ï¼‰"
  },
  "worldline_baseline": {
    "title": "ã‚¿ã‚¤ãƒˆãƒ«",
    "narrative": "èª¬æ˜ï¼ˆç°¡æ½”ï¼‰",
    "roadmap": [
      { "horizon": "1w", "outcome": "", "measurement": "", "focus": "" },
      { "horizon": "1m", "outcome": "", "measurement": "", "focus": "" },
      { "horizon": "3m", "outcome": "", "measurement": "", "focus": "" },
      { "horizon": "6m", "outcome": "", "measurement": "", "focus": "" }
    ],
    "micro_steps": [
      { "action": "", "reason": "" },
      { "action": "", "reason": "" },
      { "action": "", "reason": "" },
      { "action": "", "reason": "" },
      { "action": "", "reason": "" }
    ],
    "asset_steps": [
      { "asset": "", "type": "template|script|checklist|doc", "why": "" },
      { "asset": "", "type": "template|script|checklist|doc", "why": "" },
      { "asset": "", "type": "template|script|checklist|doc", "why": "" }
    ],
    "risks": ["è©°ã¾ã‚Šãƒã‚¤ãƒ³ãƒˆ", "è©°ã¾ã‚Šãƒã‚¤ãƒ³ãƒˆ"],
    "guardrails": ["å¾©å¸°æ‰‹é †", "å¾©å¸°æ‰‹é †"],
    "evidence": [
      { "log_excerpt": "YYYY-MM-DD [ã‚«ãƒ†ã‚´ãƒª]: ...", "why": "" },
      { "log_excerpt": "YYYY-MM-DD [ã‚«ãƒ†ã‚´ãƒª]: ...", "why": "" },
      { "log_excerpt": "YYYY-MM-DD [ã‚«ãƒ†ã‚´ãƒª]: ...", "why": "" }
    ],
    "rubric_score": 0,
    "rubric_reason": "",
    "rubric_detail": {
      "consistency": 0,
      "causality": 0,
      "actionability": 0,
      "asset_leverage": 0,
      "guardrail_sanity": 0,
      "evidence_grounding": 0
    }
  },
  "worldline_leap": {
    "title": "Leapã‚¿ã‚¤ãƒˆãƒ«",
    "narrative": "Leapèª¬æ˜",
    "roadmap": [],
    "micro_steps": [],
    "asset_steps": [],
    "risks": [],
    "guardrails": [],
    "evidence": [],
    "rubric_score": 0,
    "rubric_detail": {}
  },
  "worldline_guardrail": {
    "title": "Guardrailã‚¿ã‚¤ãƒˆãƒ«",
    "narrative": "Guardrailèª¬æ˜",
    "roadmap": [],
    "micro_steps": [],
    "asset_steps": [],
    "risks": [],
    "guardrails": [],
    "evidence": [],
    "rubric_score": 0,
    "rubric_detail": {}
  }
  }
}
\`\`\`

## é‡è¦ï¼šJSONã®æ§‹é€ ã«ã¤ã„ã¦
å¿…ãš \`worldline_baseline\`, \`worldline_leap\`, \`worldline_guardrail\` ã®3ã¤ã®ã‚­ãƒ¼ã‚’ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
é…åˆ—ï¼ˆ\`worldlines: [...]\`ï¼‰å½¢å¼ã¯é¿ã‘ã¦ãã ã•ã„ã€‚
`.trim();

      try {
        await navigator.clipboard.writeText(prompt);
        showToast("ğŸ“‹ SEED v5 Context copied! LLMã«è²¼ã‚Šä»˜ã‘ã¦æœªæ¥ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ", "ok");
      } catch (e) {
        console.error(e);
        showToast("ã‚³ãƒ”ãƒ¼å¤±æ•—ï¼ˆSSLãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ï¼‰", "err");
      }
    }

    function importSimulationResult() {
      const raw = document.getElementById("bridgeInput").value;
      if (!raw) return;

      try {
        // Markdownã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯é™¤å»
        const jsonStr = raw.replace(/```json\n?|\n?```/g, "").trim();

        // JSONã®é–‹å§‹ä½ç½®ã‚’æ¢ã™ï¼ˆã‚´ãƒŸé™¤å»ï¼‰
        const start = jsonStr.indexOf("{");
        const end = jsonStr.lastIndexOf("}");
        if (start === -1 || end === -1) throw new Error("JSON not found");

        const cleanJson = jsonStr.substring(start, end + 1);
        let data = JSON.parse(cleanJson);

        // é…åˆ—å½¢å¼(worldlines)ã§æ¥ãŸå ´åˆã®æ­£è¦åŒ–
        if (Array.isArray(data.worldlines)) {
          console.log("Normalizing worldlines array to keys...");
          const map = { "Baseline": "worldline_baseline", "Leap": "worldline_leap", "Guardrail": "worldline_guardrail" };
          data.worldlines.forEach(w => {
            const key = map[w.id] || map[w.label];
            if (key) {
              // Internal Field Normalization for different schemas
              if (!w.title && w.label) w.title = w.label;
              if (!w.narrative && w.core_assumption) w.narrative = w.core_assumption;

              if (!w.micro_steps && w.next_14_days_experiments) {
                w.micro_steps = w.next_14_days_experiments.map(e => ({
                  action: e.title || e.experiment_id,
                  reason: (e.protocol || "") + (e.success_condition ? ` (Goal: ${e.success_condition})` : "")
                }));
              }

              if (!w.risks && w.anti_patterns_to_watch) {
                w.risks = w.anti_patterns_to_watch.map(ap => `${ap.name}: ${ap.mechanism}`);
              }

              if (!w.evidence && w.evidence_anchor) {
                w.evidence = w.evidence_anchor.map(ev => ({
                  log_excerpt: `${ev.date} [${ev.category}] ${ev.text}`,
                  why: "Anchor"
                }));
              }

              data[key] = w;
            }
          });
        }

        // v5 (3ä¸–ç•Œç·š) or v4 (2ä¸–ç•Œç·š) ã‚’åˆ¤å®š
        const isV5 = data.worldline_baseline && data.worldline_leap && data.worldline_guardrail;
        const isV4 = data.persona_solid && data.persona_leap;

        if (!isV5 && !isV4) {
          throw new Error("Invalid structure: worldline_baseline/leap/guardrail or persona_solid/leap missing");
        }

        // seedKeyã‚’ç”Ÿæˆï¼ˆæœªæ¥å›ºå®šç”¨ï¼‰
        const entries = getActiveEntries();
        const recent = entries.slice().sort((a, b) => b.ts - a.ts).slice(0, 30);
        const seedKey = generateSeedKey(recent);

        // åŒä¸€seedKeyã®simulationãŒã‚ã‚Œã°å†åˆ©ç”¨ï¼ˆãƒªã‚»ãƒãƒ©ç¦æ­¢ï¼‰
        // ãŸã ã—ã€åˆ¶é™ç„¡åŠ¹åŒ–ãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        const disableLimit = document.getElementById("chkDisableLimit")?.checked;
        if (!disableLimit) {
          const existingSim = findSimulationBySeedKey(seedKey);
          if (existingSim) {
            showToast("ğŸ“Œ ä»Šæ—¥ã¯æ—¢ã«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¸ˆã¿ï¼ˆæœªæ¥å›ºå®šï¼‰", "warn");
            renderFutureCards(existingSim.result, existingSim.id);
            document.getElementById("futureCardsContainer").style.display = "grid";
            renderSimulationHistory();
            return;
          }
        }

        const simulation = {
          id: uuid(),
          createdAt: Date.now(),
          updatedAt: Date.now(),
          promptVersion: isV5 ? "SEED_v5" : "SEED_v4",
          logWindowDays: 90,
          recentCount: recent.length,
          seedKey: seedKey,  // æœªæ¥å›ºå®šç”¨ã‚­ãƒ¼
          inputDigest: {
            range: recent.length > 0 ? { from: recent[recent.length - 1].date, to: recent[0].date } : {},
            topCategories: [],
            topKeywords: []
          },
          result: data,
          commit: null
        };

        // dataCacheã«è¿½åŠ 
        dataCache.simulations = dataCache.simulations || [];
        dataCache.simulations.unshift(simulation);
        // å±¥æ­´åˆ¶é™
        if (dataCache.simulations.length > MAX_SIMULATION_HISTORY) {
          dataCache.simulations = dataCache.simulations.slice(0, MAX_SIMULATION_HISTORY);
        }
        storageSaveData(dataCache);

        // Rubric score è­¦å‘Šãƒã‚§ãƒƒã‚¯
        const worldlines = isV5
          ? [data.worldline_baseline, data.worldline_leap, data.worldline_guardrail]
          : [data.persona_solid, data.persona_leap];
        const lowScores = worldlines.filter(w => w && w.rubric_score < 90);
        if (lowScores.length > 0) {
          showToast(`âš ï¸ ${lowScores.length}ä»¶ã®ä¸–ç•Œç·šã§rubric_score<90ï¼ˆå“è³ªè­¦å‘Šï¼‰`, "warn");
        }

        renderFutureCards(data, simulation.id);
        document.getElementById("futureCardsContainer").style.display = "grid";
        renderSimulationHistory();
        showToast("ğŸ”® æœªæ¥ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆå®Œäº†ï¼", "ok");
      } catch (e) {
        showToast("JSON Parse Error: " + e.message, "err");
      }
    }

    // seedKeyç”Ÿæˆ: YYYY-MM-DD + ã‚¨ãƒ³ãƒˆãƒªæ•° + IDãƒãƒƒã‚·ãƒ¥ï¼ˆç·¨é›†è€æ€§ã‚ã‚Šï¼‰
    function generateSeedKey(recentEntries) {
      const today = formatDate(new Date());
      // IDãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚·ãƒ¥: ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ã«å¯¾ã—ã¦å®‰å®š
      const ids = recentEntries.map(e => e.id).join('|');
      const hash = simpleHash(ids);
      return `${today}_${recentEntries.length}_${hash}`;
    }

    // ç°¡æ˜“ãƒãƒƒã‚·ãƒ¥é–¢æ•°ï¼ˆdjb2ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰
    function simpleHash(str) {
      let hash = 5381;
      for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) + hash) + str.charCodeAt(i);
        hash = hash & hash; // 32bit
      }
      return Math.abs(hash).toString(36).slice(0, 8);
    }

    // seedKeyã§simulationã‚’æ¤œç´¢
    function findSimulationBySeedKey(seedKey) {
      const sims = dataCache.simulations || [];
      return sims.find(s => s.seedKey === seedKey);
    }

    // Story Mode çŠ¶æ…‹ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
    let storyModeEnabled = false;

    // Story Mode ONæ¡ä»¶: ç›´è¿‘7æ—¥ã§è³‡ç”£ã‚³ãƒŸãƒƒãƒˆ1ä»¶ä»¥ä¸Šï¼ˆæŒ‡æ‘˜4: å³å¯†åŒ–ï¼‰
    function hasRecentAssetCommit() {
      const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
      const sims = dataCache.simulations || [];
      return sims.some(sim => {
        // assetCommitsã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆmicro_stepsã®commitã¯å¯¾è±¡å¤–ï¼‰
        const assetCommits = sim.assetCommits || [];
        return assetCommits.some(ac => ac.committedAt >= sevenDaysAgo);
      });
    }

    // è³‡ç”£ã‚³ãƒŸãƒƒãƒˆï¼ˆæŒ‡æ‘˜4: micro_stepsã¨ã¯åˆ¥ç³»çµ±ï¼‰
    function commitAsset(simulationId, worldlineKey, assetIndex) {
      const sim = (dataCache.simulations || []).find(s => s.id === simulationId);
      if (!sim) {
        showToast("Simulation not found", "err");
        return;
      }

      const worldline = sim.result[worldlineKey];
      if (!worldline || !worldline.asset_steps || !worldline.asset_steps[assetIndex]) {
        showToast("Asset not found", "err");
        return;
      }

      const asset = worldline.asset_steps[assetIndex];
      const now = Date.now();

      // assetCommitsã«è¿½åŠ 
      if (!sim.assetCommits) sim.assetCommits = [];
      sim.assetCommits.push({
        worldline: worldlineKey,
        assetIndex: assetIndex,
        committedAt: now,
        asset: asset.asset,
        type: asset.type || "doc",
        why: asset.why || ""
      });
      sim.updatedAt = now;
      storageSaveData(dataCache);

      // ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†æç”»
      renderFutureCards(sim.result, sim.id);
      // MY ASSETSï¼ˆè³‡ç”£æ£šï¼‰ã‚’å³æ™‚æ›´æ–°
      renderAssetShelf();
      showToast(`ğŸ“Œ ã€Œ${asset.asset.slice(0, 20)}...ã€ã‚’è³‡ç”£ã¨ã—ã¦ç¢ºå®šã—ã¾ã—ãŸ`, "ok");
    }

    // Story Mode ãƒˆã‚°ãƒ«
    function toggleStoryMode() {
      if (!hasRecentAssetCommit()) {
        showToast("âš ï¸ Story Modeè§£ç¦ã«ã¯ç›´è¿‘7æ—¥ã§è³‡ç”£ã®ç¢ºå®šãŒå¿…è¦ã§ã™", "warn");
        return;
      }
      storyModeEnabled = !storyModeEnabled;
      localStorage.setItem("storyModeEnabled", storyModeEnabled ? "1" : "0");

      // ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†æç”»
      const latestSim = (dataCache.simulations || [])[0];
      if (latestSim) {
        renderFutureCards(latestSim.result, latestSim.id);
      }
      showToast(storyModeEnabled ? "ğŸ“– Story Mode ONï¼ˆç‰©èªè¡¨ç¤ºï¼‰" : "ğŸ“ è¨­è¨ˆå›³ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰", "ok");
    }

    // Story Mode åˆæœŸåŒ–
    function initStoryMode() {
      storyModeEnabled = localStorage.getItem("storyModeEnabled") === "1";
    }

    // Toasté€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
    function showToast(message, type = "ok") {
      const containerId = "toastContainer";
      let container = document.getElementById(containerId);
      if (!container) {
        container = document.createElement("div");
        container.id = containerId;
        container.style.cssText = "position:fixed; top:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:8px;";
        document.body.appendChild(container);
      }

      const toast = document.createElement("div");
      const bgColor = type === "ok" ? "#10b981" : type === "warn" ? "#f59e0b" : "#ef4444";
      toast.style.cssText = `
        background: ${bgColor}; color: white; padding: 12px 16px; border-radius: 8px;
        font-size: 13px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: slideIn 0.3s ease;
        max-width: 300px; word-wrap: break-word;
      `;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = "fadeOut 0.3s ease";
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    function renderFutureCards(data, simulationId) {
      const container = document.getElementById("futureCardsContainer");
      container.innerHTML = "";

      // Story Mode ãƒˆã‚°ãƒ«UIï¼ˆã‚³ãƒ³ãƒ†ãƒŠä¸Šéƒ¨ã«è¿½åŠ ï¼‰
      const canEnableStoryMode = hasRecentAssetCommit();
      const storyModeToggle = document.createElement("div");
      storyModeToggle.style.cssText = "grid-column: 1/-1; display:flex; justify-content:flex-end; gap:8px; align-items:center; margin-bottom:8px;";
      storyModeToggle.innerHTML = `
        <span style="font-size:11px; color:#888;">ğŸ“– Story Mode</span>
        <button onclick="toggleStoryMode()" 
          style="background:${storyModeEnabled ? '#d946ef' : '#333'}; 
                 color:${storyModeEnabled ? '#fff' : '#666'}; 
                 border:1px solid ${canEnableStoryMode ? '#d946ef' : '#555'}; 
                 padding:4px 10px; border-radius:4px; font-size:10px; 
                 cursor:${canEnableStoryMode ? 'pointer' : 'not-allowed'};"
          ${canEnableStoryMode ? '' : 'disabled title="ç›´è¿‘7æ—¥ã§ã‚³ãƒŸãƒƒãƒˆãŒå¿…è¦"'}>
          ${storyModeEnabled ? 'ON' : 'OFF'}
        </button>
      `;
      container.appendChild(storyModeToggle);

      // v5 or v4 åˆ¤å®š
      const isV5 = data.worldline_baseline && data.worldline_leap && data.worldline_guardrail;

      const worldlines = isV5 ? [
        { key: "worldline_baseline", color: "#38bdf8", icon: "ğŸŒ±", label: "Baselineï¼ˆç¾çŠ¶å»¶é•·ï¼‰" },
        { key: "worldline_leap", color: "#d946ef", icon: "ğŸš€", label: "Leapï¼ˆ10Xé£›èºï¼‰" },
        { key: "worldline_guardrail", color: "#22c55e", icon: "ğŸ›¡ï¸", label: "Guardrailï¼ˆå¸°é‚„ãƒ«ãƒ¼ãƒˆï¼‰" }
      ] : [
        { key: "persona_solid", color: "#38bdf8", icon: "ğŸŒ±", label: "Solid Future" },
        { key: "persona_leap", color: "#d946ef", icon: "ğŸš€", label: "Leap Future" }
      ];

      worldlines.forEach(wl => {
        const item = data[wl.key];
        if (!item) return;

        const card = document.createElement("div");
        card.style.cssText = `background:rgba(0,0,0,0.3); border:1px solid ${wl.color}; border-radius:8px; padding:16px;`;

        // ä»Šæ—¥ã®Commitæ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
        const todayCommittedSim = getTodayCommit();
        const isThisSimCommitted = todayCommittedSim && todayCommittedSim.id === simulationId;
        const committedWorldline = todayCommittedSim?.commit?.worldline;
        const committedStepIndex = todayCommittedSim?.commit?.stepIndex;

        // micro_steps (v5) or next_steps (v4)
        const steps = item.micro_steps || item.next_steps || [];
        const stepsHtml = steps.map((step, i) => {
          const isThisStepCommitted = isThisSimCommitted && committedWorldline === wl.key && committedStepIndex === i;
          const isAnyCommitToday = todayCommittedSim != null;

          let buttonHtml;
          if (isThisStepCommitted) {
            // ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒç¢ºå®šæ¸ˆã¿
            buttonHtml = `<span style="flex-shrink:0; background:#22c55e; color:#fff; padding:4px 8px; border-radius:4px; font-size:10px;">âœ“ ç¢ºå®šæ¸ˆã¿</span>`;
          } else if (isAnyCommitToday) {
            // ä»Šæ—¥ã¯æ—¢ã«åˆ¥ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç¢ºå®šæ¸ˆã¿
            buttonHtml = `<button disabled style="flex-shrink:0; background:#333; border:1px solid #555; color:#666; padding:4px 8px; border-radius:4px; font-size:10px; cursor:not-allowed;" title="ä»Šæ—¥ã®ä¸€æ­©ã¯ç¢ºå®šæ¸ˆã¿ã§ã™">---</button>`;
          } else {
            // ç¢ºå®šå¯èƒ½
            buttonHtml = `<button onclick="commitStep('${simulationId}', '${wl.key}', ${i})" style="flex-shrink:0; background:${wl.color}22; border:1px solid ${wl.color}; color:${wl.color}; padding:4px 8px; border-radius:4px; font-size:10px; cursor:pointer;">ç¢ºå®š</button>`;
          }

          return `
          <div style="margin-bottom:10px; display:flex; gap:8px; align-items:flex-start;">
            <span style="color:${wl.color}; font-family:monospace; font-weight:bold; flex-shrink:0;">#${i + 1}</span>
            <div style="flex:1;">
              <div style="font-size:13px; font-weight:bold; color:#fff;">${step.action || step.toString()}</div>
              <div style="font-size:11px; color:${wl.color}; opacity:0.7; margin-top:2px;">${step.reason || ""}</div>
            </div>
            ${buttonHtml}
          </div>
        `;
        }).join("");

        // Roadmap (v5 only)
        const roadmapHtml = item.roadmap ? `
          <div style="background:${wl.color}11; padding:10px; border-radius:6px; margin-bottom:12px; border:1px solid ${wl.color}22;">
            <div style="font-size:10px; color:${wl.color}; margin-bottom:6px; letter-spacing:1px;">ğŸ“ ROADMAP</div>
            ${item.roadmap.map(r => `
              <div style="font-size:11px; margin-bottom:4px; display:flex; gap:6px;">
                <span style="color:${wl.color}; font-weight:bold; min-width:30px;">${r.horizon}</span>
                <span style="color:#ccc;">${r.outcome}</span>
              </div>
            `).join("")}
          </div>
        ` : "";

        // Asset steps (v5 only)
        const assetHtml = item.asset_steps ? `
          <div style="background:rgba(255,215,0,0.1); padding:10px; border-radius:6px; margin-top:12px; border:1px solid rgba(255,215,0,0.3);">
            <div style="font-size:10px; color:#fbbf24; margin-bottom:6px; letter-spacing:1px;">ğŸ† ASSET STEPS</div>
            ${item.asset_steps.map((a, idx) => {
          // æ—¢ã«ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
          const sim = (dataCache.simulations || []).find(s => s.id === simulationId);
          const isCommitted = sim?.assetCommits?.some(ac => ac.worldline === wl.key && ac.assetIndex === idx);
          return `
              <div style="font-size:11px; margin-bottom:6px;">
                <div style="color:#fff; font-weight:bold;">${a.asset} <span style="color:#fbbf24; font-size:9px;">[${a.type}]</span></div>
                <div style="color:#aaa; font-size:10px;">${a.why}</div>
                <div style="display:flex; gap:6px; margin-top:4px;">
                  <button onclick="showAssetPrompt('${encodeURIComponent(JSON.stringify(a))}')" 
                    style="background:#fbbf24; color:#000; border:none; padding:2px 6px; border-radius:3px; font-size:9px; cursor:pointer;">
                    ğŸ“ è³‡ç”£ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
                  </button>
                  ${isCommitted
              ? `<span style="color:#22c55e; font-size:9px;">âœ“ ç¢ºå®šæ¸ˆã¿</span>`
              : `<button onclick="commitAsset('${simulationId}', '${wl.key}', ${idx})" 
                        style="background:#22c55e; color:#fff; border:none; padding:2px 6px; border-radius:3px; font-size:9px; cursor:pointer;">
                        ğŸ“Œ è³‡ç”£ã¨ã—ã¦ç¢ºå®š
                      </button>`
            }
                </div>
              </div>
            `}).join("")}
          </div>
        ` : "";

        // Risks/Guardrails (v5 only)
        const risksHtml = item.risks ? `
          <div style="margin-top:10px; font-size:10px;">
            <span style="color:#f59e0b;">âš¡ è©°ã¾ã‚Šãƒã‚¤ãƒ³ãƒˆ:</span> 
            <span style="color:#aaa;">${item.risks.slice(0, 2).join(", ")}</span>
          </div>
        ` : "";

        const guardrailsHtml = item.guardrails ? `
          <div style="font-size:10px; margin-top:4px;">
            <span style="color:#22c55e;">ğŸ›¡ï¸ å¾©å¸°æ‰‹é †:</span>
            <span style="color:#aaa;">${item.guardrails.slice(0, 2).join(", ")}</span>
          </div>
        ` : "";

        // Evidence (v5 only)  
        const evidenceHtml = item.evidence ? `
          <div style="background:rgba(100,100,100,0.2); padding:8px; border-radius:6px; margin-top:10px;">
            <div style="font-size:10px; color:#9ca3af; margin-bottom:4px;">ğŸ“‹ Evidence</div>
            ${item.evidence.slice(0, 2).map(e => `
              <div style="font-size:10px; color:#6b7280; margin-bottom:4px; font-style:italic;">"${e.log_excerpt?.slice(0, 50)}..."</div>
            `).join("")}
          </div>
        ` : "";

        // Rubric score with warning + detail breakdown
        const scoreColor = item.rubric_score >= 90 ? wl.color : "#ef4444";
        const rd = item.rubric_detail || {};
        const hasDetail = rd.consistency !== undefined;
        const detailHtml = hasDetail ? `
          <div style="margin-top:6px; font-size:9px; color:#9ca3af; display:flex; flex-wrap:wrap; gap:3px;">
            <span style="color:${rd.consistency >= 16 ? '#22c55e' : '#ef4444'}">ä¸€è²«${rd.consistency}</span>
            <span style="color:${rd.causality >= 16 ? '#22c55e' : '#ef4444'}">å› æœ${rd.causality}</span>
            <span style="color:${rd.actionability >= 12 ? '#22c55e' : '#ef4444'}">å®Ÿè¡Œ${rd.actionability}</span>
            <span style="color:${rd.asset_leverage >= 12 ? '#22c55e' : '#ef4444'}">è³‡ç”£${rd.asset_leverage}</span>
            <span style="color:${rd.guardrail_sanity >= 12 ? '#22c55e' : '#ef4444'}">å®‰å…¨${rd.guardrail_sanity}</span>
            <span style="color:${rd.evidence_grounding >= 12 ? '#22c55e' : '#ef4444'}">æ ¹æ‹ ${rd.evidence_grounding}</span>
          </div>
        ` : "";

        card.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
            <span style="color:${wl.color}; font-weight:bold; font-size:12px;">${wl.icon} ${wl.label}</span>
            <div style="text-align:right;">
              <span style="background:${scoreColor}; color:#fff; font-size:10px; padding:2px 6px; border-radius:4px;">
                Score: ${item.rubric_score}${item.rubric_score < 90 ? ' âš ï¸' : ''}
              </span>
              ${detailHtml}
            </div>
          </div>
          <h4 style="margin:0 0 8px; font-size:16px; color:#fff;">${item.title}</h4>
          ${storyModeEnabled
            ? `<p style="font-size:12px; color:#ccc; line-height:1.5; margin-bottom:12px; font-style:italic;">"${item.narrative}"</p>`
            : `<p style="font-size:11px; color:#666; margin-bottom:8px;">ğŸ“ è¨­è¨ˆå›³ãƒ¢ãƒ¼ãƒ‰ï¼ˆStory Modeã‚’ONã§ç‰©èªè¡¨ç¤ºï¼‰</p>`}
          ${roadmapHtml}
          <div style="background:${wl.color}11; padding:12px; border-radius:6px; border:1px solid ${wl.color}33; margin-bottom:12px;">
            <div style="font-size:10px; color:${wl.color}; margin-bottom:8px; letter-spacing:1px;">
              ${wl.key === "worldline_guardrail" ? "ğŸ›¡ï¸ 15åˆ†ã§å¾©å¸°ã®è¶³å ´ã‚’ä½œã‚‹" : "ğŸš€ MICRO STEPS (15åˆ†ä»¥å†…)"}
            </div>
            ${stepsHtml}
          </div>

          <!-- è©³ç´°æƒ…å ±ã¯æŠ˜ã‚ŠãŸãŸã¿ -->
          <details style="margin-top:8px; border-top:1px solid rgba(255,255,255,0.1); padding-top:8px;">
            <summary style="font-size:11px; color:#aaa; cursor:pointer; list-style:none; display:flex; align-items:center; gap:4px;">
              <span style="font-size:10px;">â–¶</span> è©³ç´°ã‚’è¡¨ç¤º (Assets, Risks, Evidence)
            </summary>
            <div style="padding-top:8px;">
              ${assetHtml}
              ${risksHtml}
              ${guardrailsHtml}
              ${evidenceHtml}
            </div>
          </details>
        `;
        container.appendChild(card);
      });
    }

    // Commit Step: ä¸€æ­©ã‚’ç¢ºå®šã—ã¦Ippoãƒ­ã‚°ã«è¿½åŠ ï¼ˆ1æ—¥1å›ã®ã¿ï¼‰
    function commitStep(simulationId, worldlineKey, stepIndex) {
      // 1æ—¥1Commitåˆ¶é™ãƒã‚§ãƒƒã‚¯
      if (hasTodayCommit()) {
        showToast("âš ï¸ ä»Šæ—¥ã®ä¸€æ­©ã¯ç¢ºå®šæ¸ˆã¿ã§ã™ï¼ˆ1æ—¥1å›ã®ã¿ï¼‰", "warn");
        return;
      }

      const sim = (dataCache.simulations || []).find(s => s.id === simulationId);
      if (!sim) {
        showToast("Simulation not found", "err");
        return;
      }

      const worldline = sim.result[worldlineKey];
      if (!worldline) {
        showToast("Worldline not found", "err");
        return;
      }

      const steps = worldline.micro_steps || worldline.next_steps || [];
      const step = steps[stepIndex];
      if (!step) {
        showToast("Step not found", "err");
        return;
      }

      // ä»Šæ—¥ã®æ—¥ä»˜
      const today = formatDate(new Date());
      const now = Date.now();

      // ä¸–ç•Œç·šåã‹ã‚‰æ¨å¥¨ã‚«ãƒ†ã‚´ãƒªã‚’æ¨å®š
      const categoryMap = {
        "worldline_baseline": "ä»•äº‹ãƒ»ä¼ç”»",
        "worldline_leap": "æŠ€è¡“ãƒ»é–‹ç™º",
        "worldline_guardrail": "å¿ƒãƒ»ãƒ¡ãƒ³ã‚¿ãƒ«",
        "persona_solid": "ä»•äº‹ãƒ»ä¼ç”»",
        "persona_leap": "æŠ€è¡“ãƒ»é–‹ç™º"
      };
      const category = categoryMap[worldlineKey] || inferCategory(step.action);

      // ã‚¿ã‚°ä»˜ã: ã€Future:worldline#stepã€‘
      const worldlineLabel = worldlineKey.replace("worldline_", "").replace("persona_", "");
      const taggedText = `${step.action}ã€Future:${worldlineLabel}#${stepIndex + 1}ã€‘`;

      // Ippoãƒ­ã‚°ã«è¿½åŠ 
      const newEntry = {
        id: uuid(),
        date: today,
        text: taggedText,
        category: category,
        ts: now,
        updatedAt: now,
        deleted: false,
        starred: false
      };

      entries.push(newEntry);
      saveEntriesToStorage();

      // Simulationã®commitæƒ…å ±ã‚’æ›´æ–°
      sim.commit = {
        worldline: worldlineKey,
        stepIndex: stepIndex,
        committedAt: now,
        entryId: newEntry.id
      };
      sim.updatedAt = now;
      storageSaveData(dataCache);

      // Ippoã‚¿ãƒ–ã«æˆ»ã™
      switchTab("ippo");
      renderAll();

      showToast(`âœ“ ã€Œ${step.action.slice(0, 20)}...ã€ã‚’ä»Šæ—¥ã®ä¸€æ­©ã«ç¢ºå®šã—ã¾ã—ãŸ`, "ok");
    }

    // ä»Šæ—¥ã®CommitãŒæ—¢ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    function hasTodayCommit() {
      const today = formatDate(new Date());
      const sims = dataCache.simulations || [];
      return sims.some(sim => {
        if (!sim.commit) return false;
        const commitDate = formatDate(new Date(sim.commit.committedAt));
        return commitDate === today;
      });
    }

    // ä»Šæ—¥ã®Commitæ¸ˆã¿ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–å¾—
    function getTodayCommit() {
      const today = formatDate(new Date());
      const sims = dataCache.simulations || [];
      return sims.find(sim => {
        if (!sim.commit) return false;
        const commitDate = formatDate(new Date(sim.commit.committedAt));
        return commitDate === today;
      });
    }

    // è³‡ç”£ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
    function showAssetPrompt(encodedAsset) {
      try {
        const asset = JSON.parse(decodeURIComponent(encodedAsset));

        // ã‚«ãƒ†ã‚´ãƒªå‚¾å‘ã‚’å–å¾—
        const entries = getActiveEntries();
        const categoryCount = {};
        entries.slice(0, 30).forEach(e => {
          const cat = e.category || "ãã®ä»–";
          categoryCount[cat] = (categoryCount[cat] || 0) + 1;
        });
        const topCategory = Object.entries(categoryCount).sort((a, b) => b[1] - a[1])[0];

        const prompt = `# è³‡ç”£ç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ\n\n## ç›®çš„\n${asset.asset}\n\n## å‡ºåŠ›å½¢å¼\n${asset.type === "template" ? "Markdownãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ" : asset.type === "script" ? "å®Ÿè¡Œå¯èƒ½ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆ" : asset.type === "checklist" ? "ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå½¢å¼" : "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆæ§‹é€ åŒ–ï¼‰"}\n\n## åˆ¶ç´„\n- çŸ­ãã€å†åˆ©ç”¨ã§ãã‚‹ã€ç¾å ´ã§ä½¿ãˆã‚‹\n- éåº¦ã«è¤‡é›‘ã«ã—ãªã„\n- ã™ãã«ä½¿ã„å§‹ã‚ã‚‰ã‚Œã‚‹å½¢ã§\n\n## ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‚¾å‘\næœ€è¿‘ã®ãƒ­ã‚°ã§ã¯ã€Œ${topCategory ? topCategory[0] : "ãã®ä»–"}ã€ã‚«ãƒ†ã‚´ãƒªãŒå¤šã„ã€‚\nç†ç”±: ${asset.why}\n\nå¿…è¦ãªæˆæœç‰©ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;

        // æ—¢å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã‚ã‚Œã°å‰Šé™¤
        const existing = document.getElementById("assetPromptModal");
        if (existing) existing.remove();

        const modal = document.createElement("div");
        modal.id = "assetPromptModal";
        modal.style.cssText = "position:fixed; inset:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:9999; padding:20px;";
        modal.addEventListener("click", (e) => { if (e.target === modal) modal.remove(); });

        modal.innerHTML = `
          <div style="background:#1e1e2e; border:1px solid rgba(255,215,0,0.3); border-radius:12px; padding:20px; max-width:560px; width:100%; max-height:80vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.5);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
              <div style="font-size:14px; color:#fbbf24; font-weight:bold;">ğŸ“ è³‡ç”£ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</div>
              <button onclick="document.getElementById('assetPromptModal').remove()" style="background:none; border:none; color:#9ca3af; font-size:18px; cursor:pointer; padding:4px;">âœ•</button>
            </div>
            <div style="font-size:11px; color:#fbbf24; margin-bottom:8px;">ğŸ† ${asset.asset} <span style="color:#9ca3af;">[${asset.type}]</span></div>
            <pre id="assetPromptText" style="background:rgba(0,0,0,0.4); color:#e2e8f0; padding:16px; border-radius:8px; font-size:12px; line-height:1.6; white-space:pre-wrap; word-wrap:break-word; border:1px solid rgba(255,255,255,0.1); margin:0;">${prompt}</pre>
            <div style="display:flex; gap:8px; margin-top:16px; justify-content:flex-end;">
              <button onclick="navigator.clipboard.writeText(document.getElementById('assetPromptText').textContent).then(()=>showToast('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ','ok'))" 
                style="background:#fbbf24; color:#000; border:none; padding:6px 16px; border-radius:6px; font-size:11px; cursor:pointer; font-weight:bold;">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
              <button onclick="document.getElementById('assetPromptModal').remove()" 
                style="background:rgba(255,255,255,0.1); color:#ccc; border:1px solid rgba(255,255,255,0.2); padding:6px 16px; border-radius:6px; font-size:11px; cursor:pointer;">é–‰ã˜ã‚‹</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (e) {
        console.error(e);
        showToast("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ", "err");
      }
    }

    // MY ASSETSã‹ã‚‰ã®è³‡ç”£ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤ºï¼ˆç·¨é›†ãƒ»ä¿å­˜å¯èƒ½ï¼‰
    function showMyAssetPrompt(encodedKey) {
      const key = decodeURIComponent(encodedKey);

      // å…¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ã“ã®assetã®æƒ…å ±ã‚’å–å¾—
      const sims = dataCache.simulations || [];
      let assetInfo = null;

      for (const sim of sims) {
        const commits = sim.assetCommits || [];
        for (const ac of commits) {
          if ((ac.asset || "").toLowerCase().trim() === key) {
            assetInfo = ac;
            break;
          }
        }
        if (assetInfo) break;
      }

      if (!assetInfo) {
        showToast("è³‡ç”£ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "err");
        return;
      }

      // ã‚«ãƒ†ã‚´ãƒªå‚¾å‘ã‚’å–å¾—
      const activeEntries = getActiveEntries();
      const categoryCount = {};
      activeEntries.slice(0, 30).forEach(e => {
        const cat = e.category || "ãã®ä»–";
        categoryCount[cat] = (categoryCount[cat] || 0) + 1;
      });
      const topCategory = Object.entries(categoryCount).sort((a, b) => b[1] - a[1])[0];

      // ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã„ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”Ÿæˆ
      const defaultPrompt = `# è³‡ç”£ç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ\n\n## ç›®çš„\n${assetInfo.asset}\n\n## å‡ºåŠ›å½¢å¼\n${assetInfo.type === "template" ? "Markdownãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ" : assetInfo.type === "script" ? "å®Ÿè¡Œå¯èƒ½ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆ" : assetInfo.type === "checklist" ? "ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå½¢å¼" : "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆæ§‹é€ åŒ–ï¼‰"}\n\n## åˆ¶ç´„\n- çŸ­ãã€å†åˆ©ç”¨ã§ãã‚‹ã€ç¾å ´ã§ä½¿ãˆã‚‹\n- éåº¦ã«è¤‡é›‘ã«ã—ãªã„\n- ã™ãã«ä½¿ã„å§‹ã‚ã‚‰ã‚Œã‚‹å½¢ã§\n\n## ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‚¾å‘\næœ€è¿‘ã®ãƒ­ã‚°ã§ã¯ã€Œ${topCategory ? topCategory[0] : "ãã®ä»–"}ã€ã‚«ãƒ†ã‚´ãƒªãŒå¤šã„ã€‚\nç†ç”±: ${assetInfo.why || "ï¼ˆæœªè¨­å®šï¼‰"}\n\nå¿…è¦ãªæˆæœç‰©ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;

      const promptText = assetInfo.customPrompt || defaultPrompt;

      // æ—¢å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã‚ã‚Œã°å‰Šé™¤
      const existing = document.getElementById("assetPromptModal");
      if (existing) existing.remove();

      const modal = document.createElement("div");
      modal.id = "assetPromptModal";
      modal.style.cssText = "position:fixed; inset:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:9999; padding:20px;";
      modal.addEventListener("click", (e) => { if (e.target === modal) modal.remove(); });

      const dateStr = new Date(assetInfo.committedAt).toLocaleDateString("ja-JP", { year: "numeric", month: "short", day: "numeric" });

      modal.innerHTML = `
        <div style="background:#1e1e2e; border:1px solid rgba(34,197,94,0.4); border-radius:12px; padding:20px; max-width:600px; width:100%; max-height:85vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.5);">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <div style="font-size:14px; color:#22c55e; font-weight:bold;">ğŸ“Œ ${assetInfo.asset}</div>
            <button onclick="document.getElementById('assetPromptModal').remove()" style="background:none; border:none; color:#9ca3af; font-size:18px; cursor:pointer; padding:4px;">âœ•</button>
          </div>
          <div style="font-size:10px; color:#9ca3af; margin-bottom:16px; display:flex; gap:12px;">
            <span>ğŸ“‚ ${assetInfo.type}</span>
            <span>ğŸ“… ${dateStr}</span>
            ${assetInfo.customPrompt ? '<span style="color:#fbbf24;">âœï¸ ã‚«ã‚¹ã‚¿ãƒ æ¸ˆã¿</span>' : '<span>ğŸ“ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</span>'}
          </div>
          <div style="font-size:11px; color:#ccc; margin-bottom:6px;">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆç·¨é›†å¯èƒ½ï¼‰:</div>
          <textarea id="myAssetPromptText" style="width:100%; min-height:250px; background:rgba(0,0,0,0.4); color:#e2e8f0; padding:14px; border-radius:8px; font-size:12px; line-height:1.6; border:1px solid rgba(255,255,255,0.15); resize:vertical; font-family:inherit; box-sizing:border-box;">${promptText}</textarea>
          <div style="display:flex; gap:8px; margin-top:16px; justify-content:space-between; flex-wrap:wrap;">
            <div style="display:flex; gap:8px;">
              <button onclick="saveMyAssetPrompt('${encodeURIComponent(key)}')" 
                style="background:#22c55e; color:#fff; border:none; padding:6px 16px; border-radius:6px; font-size:11px; cursor:pointer; font-weight:bold;">ğŸ’¾ ä¿å­˜</button>
              <button onclick="navigator.clipboard.writeText(document.getElementById('myAssetPromptText').value).then(()=>showToast('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ','ok'))" 
                style="background:#fbbf24; color:#000; border:none; padding:6px 16px; border-radius:6px; font-size:11px; cursor:pointer; font-weight:bold;">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            </div>
            <button onclick="document.getElementById('assetPromptModal').remove()" 
              style="background:rgba(255,255,255,0.1); color:#ccc; border:1px solid rgba(255,255,255,0.2); padding:6px 16px; border-radius:6px; font-size:11px; cursor:pointer;">é–‰ã˜ã‚‹</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // MY ASSETSã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜
    function saveMyAssetPrompt(encodedKey) {
      const key = decodeURIComponent(encodedKey);
      const textarea = document.getElementById("myAssetPromptText");
      if (!textarea) return;

      const newPrompt = textarea.value.trim();
      if (!newPrompt) {
        showToast("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒç©ºã§ã™", "warn");
        return;
      }

      // å…¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®è©²å½“assetCommitã«customPromptã‚’ä¿å­˜
      const sims = dataCache.simulations || [];
      let updated = false;
      sims.forEach(sim => {
        const commits = sim.assetCommits || [];
        commits.forEach(ac => {
          if ((ac.asset || "").toLowerCase().trim() === key) {
            ac.customPrompt = newPrompt;
            ac.updatedAt = Date.now();
            updated = true;
          }
        });
      });

      if (updated) {
        storageSaveData(dataCache);
        showToast("ğŸ’¾ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ", "ok");
      } else {
        showToast("ä¿å­˜å…ˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "err");
      }
    }

    // Simulation History UI
    function renderSimulationHistory() {
      const containerId = "simulationHistory";
      let container = document.getElementById(containerId);

      // ã‚³ãƒ³ãƒ†ãƒŠãŒãªã‘ã‚Œã°ä½œæˆ
      if (!container) {
        const futureContainer = document.getElementById("futureCardsContainer");
        if (!futureContainer) return;

        container = document.createElement("div");
        container.id = containerId;
        container.style.cssText = "margin-top:24px; padding:16px; background:rgba(0,0,0,0.2); border-radius:8px;";
        futureContainer.parentNode.insertBefore(container, futureContainer.nextSibling);
      }

      const sims = (dataCache.simulations || []).filter(s => !s.deleted);
      if (sims.length === 0) {
        container.innerHTML = `
          <div style="font-size:12px; color:#9ca3af;">ğŸ“š ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
        `;
        return;
      }

      container.innerHTML = `
        <div style="font-size:12px; color:#38bdf8; margin-bottom:12px; font-weight:bold;">ğŸ“š SIMULATION HISTORY (ç›´è¿‘${Math.min(sims.length, 10)}ä»¶)</div>
        <div style="display:flex; flex-direction:column; gap:8px;">
          ${sims.slice(0, 10).map((sim, i) => {
        const date = new Date(sim.createdAt).toLocaleString("ja-JP", { month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" });
        const isV5 = sim.result?.worldline_baseline;
        const titles = isV5
          ? [sim.result.worldline_baseline?.title, sim.result.worldline_leap?.title, sim.result.worldline_guardrail?.title].filter(Boolean)
          : [sim.result?.persona_solid?.title, sim.result?.persona_leap?.title].filter(Boolean);
        const hasCommit = !!sim.commit;

        // DEBUG INFO
        const debugInfo = `ID:${sim.id.slice(0, 4)}.. Created:${sim.createdAt} Updated:${sim.updatedAt}`;

        return `
              <div onclick="loadSimulation('${sim.id}')" 
                style="cursor:pointer; padding:8px 12px; background:rgba(56,189,248,0.1); border:1px solid rgba(56,189,248,0.2); border-radius:6px; display:flex; justify-content:space-between; align-items:center;"
                onmouseover="this.style.background='rgba(56,189,248,0.2)'" 
                onmouseout="this.style.background='rgba(56,189,248,0.1)'">
                <div>
                  <div style="display:flex; align-items:center; gap:6px;">
                    <span style="font-size:10px; color:#9ca3af;">${date}</span>
                    <span style="font-size:9px; color:#555; font-family:monospace;">${debugInfo}</span>
                  </div>
                  <span style="font-size:11px; color:#fff; margin-left:8px;">${titles[0]?.slice(0, 30) || "Untitled"}...</span>
                  ${hasCommit ? '<span style="color:#22c55e; font-size:10px; margin-left:6px;">âœ“ committed</span>' : ''}
                </div>
                <div style="display:flex; align-items:center; gap:8px;">
              <span style="font-size:10px; color:#38bdf8;">${sim.promptVersion}</span>
              <button onclick="event.stopPropagation(); deleteSimulation('${sim.id}')" 
                style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:14px; opacity:0.7;" 
                onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'" title="ã“ã®å±¥æ­´ã‚’å‰Šé™¤">
                ğŸ—‘ï¸
              </button>
            </div>
          </div>
        `;
      }).join("")}
        </div>
        ${sims.length >= 2 ? `
          <div id="butterflyDiff" style="margin-top:16px;"></div>
        ` : ""}
      `;

      // Butterfly Diff ã‚’æç”»
      if (sims.length >= 2) {
        renderButterflyDiff(sims[0], sims[1]);
      }

      // Asset Shelf ã‚’æç”»
      renderAssetShelf();
    }

    // å±¥æ­´ã‹ã‚‰èª­ã¿è¾¼ã¿
    function loadSimulation(simId) {
      const sim = (dataCache.simulations || []).find(s => s.id === simId);
      if (!sim || !sim.result) {
        showToast("Simulation not found", "err");
        return;
      }
      renderFutureCards(sim.result, sim.id);
      document.getElementById("futureCardsContainer").style.display = "grid";
      showToast("ğŸ“‚ å±¥æ­´ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ", "ok");
    }

    function deleteSimulation(simId) {
      if (!confirm("ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰")) return;

      const sim = (dataCache.simulations || []).find(s => s.id === simId);
      if (!sim) return;

      // è«–ç†å‰Šé™¤ (åŒæœŸã§ã®å¾©æ´»é˜²æ­¢)
      sim.deleted = true;
      sim.updatedAt = Date.now();

      storageSaveData(dataCache);

      // UIæ›´æ–°
      renderSimulationHistory();
      showToast("ğŸ—‘ï¸ å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ", "ok");

      // ã‚‚ã—è¡¨ç¤ºä¸­ã®ã‚«ãƒ¼ãƒ‰ãŒå‰Šé™¤ã•ã‚ŒãŸã‚‚ã®ãªã‚‰ã€ã‚«ãƒ¼ãƒ‰ã‚‚æ¶ˆã™ï¼ˆUXã¨ã—ã¦è‡ªç„¶ï¼‰
      // ãŸã ã—ä»Šå›ã¯å¿…é ˆã§ã¯ãªã„ã®ã§ã€Historyã®å†æç”»ã®ã¿ã¨ã™ã‚‹
    }

    // Butterfly Diff: æœ€æ–°ã¨å‰å›ã®å·®åˆ†
    function renderButterflyDiff(latest, previous) {
      const container = document.getElementById("butterflyDiff");
      if (!container) return;

      console.log("ğŸ¦‹ Butterfly Diff Debug:", { latest, previous });

      // 1. åŸºæœ¬æƒ…å ±ï¼ˆæ—¥ä»˜å·®åˆ†ï¼‰
      const daysDiff = Math.round((latest.createdAt - previous.createdAt) / (1000 * 60 * 60 * 24));
      const dateLabel = daysDiff === 0 ? "Same Day" : `${daysDiff} days later`;

      // 2. Trajectory Shift (v5.2 feature)
      const shiftText = latest.result?.meta?.trajectory_shift || "";

      // 3. Rubric Score Comparison
      const getScore = (sim, type) => sim?.result?.[`worldline_${type}`]?.rubric_score || 0;
      const compareScore = (type, label) => {
        const curr = getScore(latest, type);
        const prev = getScore(previous, type);
        const diff = curr - prev;
        const color = diff > 0 ? "#22c55e" : diff < 0 ? "#ef4444" : "#9ca3af";
        const sign = diff > 0 ? "+" : diff < 0 ? "" : "Â±";
        return `
          <div style="display:flex; flex-direction:column; align-items:center;">
            <span style="font-size:9px; color:#aaa;">${label}</span>
            <span style="font-size:12px; font-weight:bold; color:${color};">${curr} <span style="font-size:9px;">(${sign}${diff})</span></span>
          </div>
        `;
      };

      const scoreDiffHtml = (latest.result?.meta?.version === "SEED_v5") ? `
        <div style="display:flex; justify-content:space-around; margin-bottom:12px; background:rgba(0,0,0,0.2); padding:8px; border-radius:6px;">
          ${compareScore("baseline", "Baseline")}
          ${compareScore("leap", "Leap")}
          ${compareScore("guardrail", "Guardrail")}
        </div>
      ` : "";

      // Stepæ­£è¦åŒ–ï¼ˆæŒ‡æ‘˜3: v4/v5ä¸¡å¯¾å¿œï¼‰
      function normalizeStep(raw) {
        if (typeof raw === 'string') return raw.toLowerCase().trim();
        return (raw.action || raw.title || '').toLowerCase().trim();
      }

      // é †åºã‚ã‚Šãƒªã‚¹ãƒˆã‚’è¿”ã™ï¼ˆæŒ‡æ‘˜2å¯¾å¿œï¼‰
      function getStepsList(sim) {
        const r = sim.result;
        if (!r) return [];
        const worldlines = r.worldline_baseline
          ? [r.worldline_baseline, r.worldline_leap, r.worldline_guardrail]
          : [r.persona_solid, r.persona_leap];
        return worldlines.flatMap(w =>
          (w?.micro_steps || w?.next_steps || []).map(s => normalizeStep(s))
        ).filter(s => s);
      }

      const latestList = getStepsList(latest);
      const previousList = getStepsList(previous);
      const latestSteps = new Set(latestList);
      const previousSteps = new Set(previousList);

      const added = [...latestSteps].filter(s => !previousSteps.has(s));
      const removed = [...previousSteps].filter(s => !latestSteps.has(s));

      // æŒ‡æ‘˜2: movedï¼ˆé †ä½å¤‰å‹•ï¼‰ç®—å‡º
      const prevIndexMap = new Map(previousList.map((s, i) => [s, i]));
      const moved = latestList
        .filter(s => previousSteps.has(s))
        .map(s => ({ step: s, latestIdx: latestList.indexOf(s), prevIdx: prevIndexMap.get(s) }))
        .filter(m => Math.abs(m.latestIdx - m.prevIdx) >= 1)
        .slice(0, 3);

      // å¤‰åŒ–é‡ã‚¹ã‚³ã‚¢ (0-100)
      const totalSteps = Math.max(latestSteps.size + previousSteps.size, 1);
      const changeScore = Math.round((added.length + removed.length) / totalSteps * 100);

      container.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div style="font-size:12px; color:#d946ef; font-weight:bold;">ğŸ¦‹ BUTTERFLY DIFF</div>
          <div style="font-size:10px; color:#666;">vs Previous (${dateLabel})</div>
        </div>
        
        ${shiftText ? `
          <div style="font-size:11px; color:#e2e8f0; background:rgba(217, 70, 239, 0.1); border-left:3px solid #d946ef; padding:8px; margin-bottom:12px; line-height:1.4;">
            <div style="font-size:9px; color:#d946ef; margin-bottom:2px; font-weight:bold;">TRAJECTORY SHIFT</div>
            ${shiftText}
          </div>
        ` : ""}

        ${scoreDiffHtml}

        <div style="font-size:11px; color:#9ca3af; margin-bottom:8px;">
          Step Change: <span style="color:${changeScore > 30 ? '#f59e0b' : '#22c55e'}; font-weight:bold;">${changeScore}%</span>
        </div>
        ${added.length > 0 ? `
          <div style="font-size:10px; margin-bottom:6px;">
            <span style="color:#22c55e;">+ è¿½åŠ ã•ã‚ŒãŸã‚¹ãƒ†ãƒƒãƒ—:</span>
            <div style="color:#aaa; margin-left:12px;">${added.slice(0, 3).map(s => `â€¢ ${s?.slice(0, 40)}...`).join("<br>")}</div>
          </div>
        ` : ""}
        ${removed.length > 0 ? `
          <div style="font-size:10px; margin-bottom:6px;">
            <span style="color:#ef4444;">- å‰Šé™¤ã•ã‚ŒãŸã‚¹ãƒ†ãƒƒãƒ—:</span>
            <div style="color:#aaa; margin-left:12px;">${removed.slice(0, 3).map(s => `â€¢ ${s?.slice(0, 40)}...`).join("<br>")}</div>
          </div>
        ` : ""}
        ${moved.length > 0 ? `
          <div style="font-size:10px; margin-bottom:6px;">
            <span style="color:#f59e0b;">â†•ï¸ é †ä½å¤‰å‹•:</span>
            <div style="color:#aaa; margin-left:12px;">${moved.map(m => `â€¢ ${m.step?.slice(0, 30)}... (${m.prevIdx + 1}â†’${m.latestIdx + 1})`).join("<br>")}</div>
          </div>
        ` : ""}
        ${added.length === 0 && removed.length === 0 && moved.length === 0 ? `
          <div style="font-size:10px; color:#6b7280;">ã‚¹ãƒ†ãƒƒãƒ—ã«å¤§ããªå¤‰åŒ–ã¯ã‚ã‚Šã¾ã›ã‚“</div>
        ` : ""}
      `;
    }

    // Asset Shelf: å…¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰è³‡ç”£ã‚¹ãƒ†ãƒƒãƒ—ã‚’åé›†ï¼ˆææ¡ˆãƒ™ãƒ¼ã‚¹ï¼‰
    function getAllAssets() {
      const sims = dataCache.simulations || [];
      const assetMap = new Map(); // assetåã‚’ã‚­ãƒ¼ã«ã—ã¦é‡è¤‡ã‚’ç®¡ç†

      sims.forEach(sim => {
        const result = sim.result;
        if (!result) return;

        const worldlines = result.worldline_baseline
          ? [result.worldline_baseline, result.worldline_leap, result.worldline_guardrail]
          : [result.persona_solid, result.persona_leap];

        worldlines.forEach(wl => {
          if (!wl?.asset_steps) return;
          wl.asset_steps.forEach(a => {
            const key = (a.asset || "").toLowerCase().trim();
            if (!key) return;

            if (assetMap.has(key)) {
              assetMap.get(key).count++;
            } else {
              assetMap.set(key, {
                asset: a.asset,
                type: a.type || "doc",
                why: a.why || "",
                firstSeenAt: sim.createdAt,
                count: 1
              });
            }
          });
        });
      });

      return Array.from(assetMap.values()).sort((a, b) => b.count - a.count);
    }

    // ç¢ºå®šæ¸ˆã¿è³‡ç”£ã‚’å…¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰æ¨ªæ–­åé›†
    function getCommittedAssets() {
      const sims = dataCache.simulations || [];
      const commitMap = new Map();

      sims.forEach(sim => {
        const commits = sim.assetCommits || [];
        commits.forEach(ac => {
          const key = (ac.asset || "").toLowerCase().trim();
          if (!key) return;

          if (commitMap.has(key)) {
            const existing = commitMap.get(key);
            if (ac.committedAt > existing.committedAt) {
              existing.committedAt = ac.committedAt;
              if (ac.why) existing.why = ac.why;
            }
            existing.commitCount++;
          } else {
            commitMap.set(key, {
              mapKey: key,
              asset: ac.asset,
              type: ac.type || "doc",
              why: ac.why || "",
              customPrompt: ac.customPrompt || null,
              committedAt: ac.committedAt,
              worldline: ac.worldline,
              simulationId: sim.id,
              commitCount: 1
            });
          }
        });
      });

      return Array.from(commitMap.values()).sort((a, b) => b.committedAt - a.committedAt);
    }

    // Asset Shelf UIï¼ˆ2å±¤æ§‹é€ : MY ASSETS + ASSET IDEASï¼‰
    function renderAssetShelf() {
      const containerId = "assetShelf";
      let container = document.getElementById(containerId);

      // ã‚³ãƒ³ãƒ†ãƒŠãŒãªã‘ã‚Œã°ä½œæˆ
      if (!container) {
        const historyContainer = document.getElementById("simulationHistory");
        if (!historyContainer) return;

        container = document.createElement("div");
        container.id = containerId;
        container.style.cssText = "margin-top:24px; padding:16px; background:rgba(255,215,0,0.05); border:1px solid rgba(255,215,0,0.2); border-radius:8px;";
        historyContainer.parentNode.insertBefore(container, historyContainer.nextSibling);
      }

      const committedAssets = getCommittedAssets();
      const allAssets = getAllAssets();

      const typeIcons = {
        template: "ğŸ“„",
        script: "âš™ï¸",
        checklist: "âœ…",
        doc: "ğŸ“‹"
      };

      // â”€â”€ 1. MY ASSETSï¼ˆç¢ºå®šæ¸ˆã¿è³‡ç”£ï¼‰â”€â”€
      let myAssetsHtml;
      if (committedAssets.length === 0) {
        myAssetsHtml = `
          <div style="font-size:11px; color:#9ca3af; padding:12px; background:rgba(0,0,0,0.2); border-radius:6px;">
            ã¾ã ç¢ºå®šã—ãŸè³‡ç”£ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
            ä¸–ç•Œç·šã‚«ãƒ¼ãƒ‰ã®ã€ŒğŸ“Œ è³‡ç”£ã¨ã—ã¦ç¢ºå®šã€ã§è³‡ç”£ã‚’ç™»éŒ²ã§ãã¾ã™ã€‚
          </div>
        `;
      } else {
        // typeåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const byType = {};
        committedAssets.forEach(a => {
          const t = a.type || "doc";
          if (!byType[t]) byType[t] = [];
          byType[t].push(a);
        });

        myAssetsHtml = `
          <div style="font-size:10px; color:#9ca3af; margin-bottom:10px;">
            ç¢ºå®šæ¸ˆã¿ ${committedAssets.length} ä»¶ ï½œ ä½¿ãˆã‚‹ã¨ãã«ä½¿ã†è³‡ç”£ã‚¹ãƒˆãƒƒã‚¯
          </div>
          ${Object.entries(byType).map(([type, items]) => `
            <div style="margin-bottom:10px;">
              <div style="font-size:11px; color:#22c55e; margin-bottom:6px;">${typeIcons[type] || "ğŸ“‹"} ${type.toUpperCase()} (${items.length})</div>
              <div style="display:flex; flex-wrap:wrap; gap:6px;">
                ${items.map(a => {
          const dateStr = new Date(a.committedAt).toLocaleDateString("ja-JP", { month: "short", day: "numeric" });
          const escapedKey = encodeURIComponent(a.mapKey);
          return `
                    <div onclick="showMyAssetPrompt('${escapedKey}')" style="background:rgba(34,197,94,0.15); border:1px solid rgba(34,197,94,0.4); padding:6px 10px; border-radius:4px; font-size:10px; cursor:pointer; transition:all 0.15s;" onmouseover="this.style.background='rgba(34,197,94,0.3)';this.style.transform='translateY(-1px)'" onmouseout="this.style.background='rgba(34,197,94,0.15)';this.style.transform='none'">
                      <div style="color:#fff; font-weight:bold;">${a.asset.slice(0, 40)}${a.asset.length > 40 ? '...' : ''}</div>
                      <div style="color:#22c55e; font-size:9px; margin-top:2px;">âœ“ ${dateStr}${a.commitCount > 1 ? ` Ã—${a.commitCount}å›` : ''} Â· ğŸ“ ã‚¯ãƒªãƒƒã‚¯ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</div>
                    </div>
                  `;
        }).join("")}
              </div>
            </div>
          `).join("")}
        `;
      }

      // â”€â”€ 2. ASSET IDEASï¼ˆè³‡ç”£æ¡ˆ / æŠ˜ã‚ŠãŸãŸã¿ï¼‰â”€â”€
      let ideasHtml = "";
      if (allAssets.length > 0) {
        const byType = {};
        allAssets.forEach(a => {
          const t = a.type || "doc";
          if (!byType[t]) byType[t] = [];
          byType[t].push(a);
        });

        ideasHtml = `
          <details style="margin-top:16px; border-top:1px solid rgba(255,215,0,0.15); padding-top:12px;">
            <summary style="font-size:11px; color:#fbbf24; cursor:pointer; list-style:none; display:flex; align-items:center; gap:4px;">
              <span style="font-size:10px;">â–¶</span> ğŸ’¡ ASSET IDEASï¼ˆAIã®è³‡ç”£æ¡ˆ ${allAssets.length}ä»¶ï¼‰
            </summary>
            <div style="padding-top:10px;">
              <div style="font-size:10px; color:#9ca3af; margin-bottom:8px;">
                å…¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ææ¡ˆã‚’é›†ç´„ ï½œ è¤‡æ•°å›å‡ºç¾ = é‡è¦åº¦é«˜
              </div>
              ${Object.entries(byType).map(([type, items]) => `
                <div style="margin-bottom:10px;">
                  <div style="font-size:11px; color:#fbbf24; margin-bottom:6px;">${typeIcons[type] || "ğŸ“‹"} ${type.toUpperCase()} (${items.length})</div>
                  <div style="display:flex; flex-wrap:wrap; gap:6px;">
                    ${items.map(a => `
                      <div style="background:rgba(251,191,36,0.1); border:1px solid rgba(251,191,36,0.3); padding:6px 10px; border-radius:4px; font-size:10px;">
                        <div style="color:#fff; font-weight:bold;">${a.asset.slice(0, 30)}${a.asset.length > 30 ? '...' : ''}</div>
                        ${a.count > 1 ? `<div style="color:#fbbf24; font-size:9px;">Ã—${a.count}å›å‡ºç¾</div>` : ''}
                      </div>
                    `).join("")}
                  </div>
                </div>
              `).join("")}
            </div>
          </details>
        `;
      }

      container.innerHTML = `
        <div style="font-size:12px; color:#22c55e; margin-bottom:12px; font-weight:bold;">ğŸ“Œ MY ASSETSï¼ˆç¢ºå®šæ¸ˆã¿è³‡ç”£ï¼‰</div>
        ${myAssetsHtml}
        ${ideasHtml}
        <div style="margin-top:16px; padding:12px; background:rgba(100,100,100,0.1); border-radius:6px; border:1px dashed #555;">
          <div style="font-size:10px; color:#9ca3af; margin-bottom:6px;">ğŸ“¦ æœˆ1æ£šå¸ã—æ¨å¥¨</div>
          <div style="font-size:9px; color:#6b7280; line-height:1.4;">
            è³‡ç”£ãŒå¢—ãˆãŸã‚‰æœˆ1ã§æ£šå¸ã—ã€‚<br>
            â€¢ <span style="color:#22c55e;">çµ±åˆ</span>: é‡è¤‡ãƒ»é¡ä¼¼ã‚’1ã¤ã«<br>
            â€¢ <span style="color:#ef4444;">å‰Šé™¤</span>: ä½¿ã‚ãªããªã£ãŸã‚‚ã®ã‚’æ•´ç†<br>
            â€¢ <span style="color:#fbbf24;">æ˜‡æ ¼</span>: é »åº¦é«˜ã„ã‚‚ã®ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬åŒ–
          </div>
        </div>
      `;
    }

    function getChartColors() {
      return {
        accent: '#38bdf8', /* Sky-400 */
        accentSoft: 'rgba(56, 189, 248, 0.2)',
        mental: '#a78bfa', /* Violet-400 */
        mentalSoft: 'rgba(167, 139, 250, 0.2)',
        grid: 'rgba(255, 255, 255, 0.08)',
        text: '#94a3b8' /* Slate-400 */
      };
    }

    // ... (renderRadarChart, renderFlowChart are already here) ...



    function renderKeywordChart() {
      const ctx = document.getElementById('chartKeywords');
      if (!ctx) return;

      const entries = getActiveEntries();
      const wordCounts = {};

      // è¾æ›¸ã®å…¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦é›†è¨ˆï¼ˆç°¡æ˜“çš„ã ãŒç¢ºå®Ÿï¼‰
      const allKeywords = [];
      Object.values(CATEGORY_KEYWORDS).forEach(list => allKeywords.push(...list));

      // é‡è¤‡é™¤å¤–
      const uniqueKeywords = [...new Set(allKeywords)];

      // å…¨ã‚¨ãƒ³ãƒˆãƒªã‚¹ã‚­ãƒ£ãƒ³
      // â€»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ³¨æ„: O(Entries * Keywords) ãªã®ã§é‡ã„ã‹ã‚‚ã€‚æœ€é©åŒ–æ¨å¥¨ã€‚
      // ã“ã“ã§ã¯ç°¡æ˜“å®Ÿè£…ã€‚
      entries.forEach(e => {
        const text = e.text || "";
        uniqueKeywords.forEach(word => {
          if (text.includes(word)) {
            wordCounts[word] = (wordCounts[word] || 0) + 1;
          }
        });
      });

      // Top 30ã‚’æŠ½å‡º
      const sortedWords = Object.entries(wordCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 30);

      // ãƒãƒ–ãƒ«ãƒãƒ£ãƒ¼ãƒˆç”¨ã«é…ç½®
      // Xè»¸: ã‚«ãƒ†ã‚´ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹çš„ãªã‚‚ã®ï¼Ÿ Yè»¸: ãƒ©ãƒ³ãƒ€ãƒ ï¼Ÿ
      // ã“ã“ã§ã¯WordCloudã®ä»£ç”¨ã¨ã—ã¦ã€æ•£å¸ƒå›³ã«ãƒ©ãƒ³ãƒ€ãƒ é…ç½®ã™ã‚‹ã€‚

      const bubbles = sortedWords.map((item, i) => {
        const [word, count] = item;
        return {
          x: Math.random() * 100,
          y: Math.random() * 100,
          r: Math.min(count * 2 + 5, 30),
          word: word,
          count: count
        };
      });

      const colors = getChartColors();

      new Chart(ctx, {
        type: 'bubble',
        data: {
          datasets: [{
            label: 'Keywords',
            data: bubbles,
            backgroundColor: (ctx) => {
              // ãƒ©ãƒ³ãƒ€ãƒ ã§è‰²ã‚’å¤‰ãˆã‚‹æ¼”å‡º
              const v = ctx.raw?.count || 0;
              return v > 5 ? colors.accentSoft : colors.mentalSoft;
            },
            borderColor: colors.grid,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { display: false }, // è»¸ã¯éš ã™
            y: { display: false }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.raw.word}: ${ctx.raw.count}`
              }
            },
            // ãƒãƒ–ãƒ«ã®ä¸­å¿ƒã«æ–‡å­—ã‚’è¡¨ç¤ºã—ãŸã„ãŒã€æ¨™æº–ã§ã¯é›£ã—ã„ã€‚
            // Tooltipã§ç¢ºèªã—ã¦ã‚‚ã‚‰ã†å‰²ã‚Šåˆ‡ã‚Šã€‚
          }
        }
      });
    }

    function renderRadarChart() {
      const ctx = document.getElementById('chartRadar');
      if (!ctx) return;

      const entries = getActiveEntries();
      const counts = {};

      // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®é›†è¨ˆ
      CATEGORY_LIST.forEach(cat => {
        counts[cat] = 0;
      });

      entries.forEach(e => {
        const cat = e.category || "ãã®ä»–";
        if (counts[cat] !== undefined) {
          counts[cat]++;
        }
      });

      const labels = CATEGORY_LIST;
      const dataCounts = labels.map(c => counts[c]);

      const colors = getChartColors();

      // æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆã®ç ´æ£„
      const existingChart = Chart.getChart(ctx);
      if (existingChart) existingChart.destroy();

      new Chart(ctx, {
        type: 'radar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'æŠ•ç¨¿æ•°',
              data: dataCounts,
              backgroundColor: colors.accentSoft,
              borderColor: colors.accent,
              pointBackgroundColor: colors.accent,
              borderWidth: 2,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              angleLines: { color: colors.grid },
              grid: { color: colors.grid },
              pointLabels: { color: colors.text, font: { size: 10 } },
              ticks: { display: false, backdropColor: 'transparent' }
            }
          },
          plugins: {
            legend: { labels: { color: colors.text } }
          }
        }
      });
    }

    function renderFlowChart() {
      const ctx = document.getElementById('chartFlow');
      if (!ctx) return;

      // éå»30æ—¥åˆ†ã®æ—¥ä»˜ç”Ÿæˆ
      const dates = [];
      const mentalData = [];

      for (let i = 29; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const ymd = formatDate(d); // YYYY-MM-DD
        dates.push(ymd);

        // æ—¥æ¬¡ãƒ¡ãƒ³ã‚¿ãƒ«å‚ç…§
        const state = (dataCache.dailyStates || {})[ymd];
        mentalData.push(state && state.mental ? state.mental : null);
      }

      // æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆã®ç ´æ£„ï¼ˆå†æç”»æ™‚ã®é‡è¤‡é˜²æ­¢ï¼‰
      const existingChart = Chart.getChart(ctx);
      if (existingChart) existingChart.destroy();

      const colors = getChartColors();

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates.map(d => d.slice(5)), // MM-DD
          datasets: [
            {
              label: 'Mental (æ—¥æ¬¡)',
              data: mentalData,
              borderColor: colors.mental,
              backgroundColor: colors.mental,
              tension: 0.4,
              spanGaps: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              grid: { color: colors.grid },
              ticks: { color: colors.text, maxTicksLimit: 10 }
            },
            y: {
              min: 0,
              max: 5,
              grid: { color: colors.grid },
              ticks: { color: colors.text, stepSize: 1 }
            }
          },
          plugins: {
            legend: { labels: { color: colors.text } },
            tooltip: {
              callbacks: {
                title: (items) => {
                  const idx = items[0].dataIndex;
                  return dates[idx]; // YYYY-MM-DDè¡¨ç¤º
                }
              }
            }
          }
        }
      });
    }

    function renderCrossTodChart() {
      const ctx = document.getElementById('chartCrossTod');
      if (!ctx) return;

      const entries = getActiveEntries();

      // ã‚«ãƒ†ã‚´ãƒªÃ—TODé›†è¨ˆåˆæœŸåŒ–
      const todCounts = {};
      const labels = CATEGORY_LIST.slice(); // ã‚³ãƒ”ãƒ¼

      labels.forEach(cat => {
        todCounts[cat] = { morning: 0, day: 0, night: 0, none: 0 };
      });

      entries.forEach(e => {
        const cat = e.category || "ãã®ä»–";
        // æœªçŸ¥ã®ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Œã°è¿½åŠ ï¼ˆå¿µã®ãŸã‚ï¼‰
        if (!todCounts[cat]) {
          todCounts[cat] = { morning: 0, day: 0, night: 0, none: 0 };
          if (!labels.includes(cat)) labels.push(cat);
        }

        const tods = e.tod || [];
        if (tods.length === 0) {
          todCounts[cat].none++;
        } else {
          tods.forEach(t => {
            if (t === "morning") todCounts[cat].morning++;
            else if (t === "day") todCounts[cat].day++;
            else if (t === "night") todCounts[cat].night++;
          });
        }
      });

      const dataMorning = labels.map(c => todCounts[c].morning);
      const dataDay = labels.map(c => todCounts[c].day);
      const dataNight = labels.map(c => todCounts[c].night);
      const dataNone = labels.map(c => todCounts[c].none);

      const colors = getChartColors();

      // æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆã®ç ´æ£„
      const existingChart = Chart.getChart(ctx);
      if (existingChart) existingChart.destroy();

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'æœ',
              data: dataMorning,
              backgroundColor: '#fcd34d', /* Amber-300 */
              stack: 'Stack 0',
            },
            {
              label: 'æ˜¼',
              data: dataDay,
              backgroundColor: '#38bdf8', /* Sky-400 */
              stack: 'Stack 0',
            },
            {
              label: 'å¤œ',
              data: dataNight,
              backgroundColor: '#818cf8', /* Indigo-400 */
              stack: 'Stack 0',
            },
            {
              label: 'æœªè¨­å®š',
              data: dataNone,
              backgroundColor: 'rgba(255, 255, 255, 0.05)',
              stack: 'Stack 0',
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: true,
              grid: { color: colors.grid },
              ticks: { color: colors.text }
            },
            y: {
              stacked: true,
              grid: { color: colors.grid },
              ticks: { color: colors.text }
            }
          },
          plugins: {
            legend: { labels: { color: colors.text } },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          }
        }
      });
    }

    const STORAGE_KEY = "ippoLogEntries_v2";
    const NEXT_MEMO_KEY = "ippoNextMemo_v1";

    // ===== OneDrive (MSAL + Microsoft Graph) =====
    const OD_SETTINGS_KEY = "ippoOneDriveSettings_v2";
    const OD_CACHE_KEY = "ippoDataCache_v1";
    const OD_QUEUE_KEY = "ippoSyncQueue_v1";
    const OD_MIGRATION_KEY = "ippoMigrationDone_v1";
    const OD_STATUS_KEY = "ippoSyncStatus_v1";

    const DEFAULT_FILE_PATH = "/Apps/IppoDashboard/ippo_data.json";
    const OD_SCOPES = ["Files.ReadWrite.AppFolder", "offline_access"];

    let odMsalApp = null;
    let odAccount = null;
    let odEtag = null;

    let dataCache = { schemaVersion: 2, entries: [], memos: [], simulations: [] };

    function uuid() {
      if (window.crypto?.randomUUID) return window.crypto.randomUUID();
      const arr = new Uint8Array(16);
      window.crypto?.getRandomValues?.(arr);
      if (!arr.length) {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
          const r = Math.random() * 16 | 0;
          const v = c === "x" ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }
      arr[6] = (arr[6] & 0x0f) | 0x40;
      arr[8] = (arr[8] & 0x3f) | 0x80;
      const hex = Array.from(arr, b => b.toString(16).padStart(2, "0")).join("");
      return `${hex.slice(0, 8)}-${hex.slice(8, 12)}-${hex.slice(12, 16)}-${hex.slice(16, 20)}-${hex.slice(20)}`;
    }

    function odGetRedirectUriDefault() {
      return location.href.split("#")[0].split("?")[0];
    }

    function odLoadSettings() {
      try { return JSON.parse(localStorage.getItem(OD_SETTINGS_KEY) || "null"); } catch { return null; }
    }
    function odSaveSettings(s) {
      localStorage.setItem(OD_SETTINGS_KEY, JSON.stringify(s));
    }
    function odClearSettings() {
      localStorage.removeItem(OD_SETTINGS_KEY);
    }

    function odLoadCache() {
      try {
        const raw = localStorage.getItem(OD_CACHE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || !Array.isArray(parsed.entries) || !Array.isArray(parsed.memos)) return null;
        return parsed;
      } catch {
        return null;
      }
    }

    function odLoadSyncMeta() {
      try {
        const raw = localStorage.getItem(OD_STATUS_KEY);
        return raw ? JSON.parse(raw) : {};
      } catch {
        return {};
      }
    }

    function odSaveSyncMeta(meta) {
      localStorage.setItem(OD_STATUS_KEY, JSON.stringify(meta));
    }

    function odSaveCache(cache) {
      localStorage.setItem(OD_CACHE_KEY, JSON.stringify(cache));
    }

    function odLoadQueue() {
      try {
        const raw = localStorage.getItem(OD_QUEUE_KEY);
        const parsed = raw ? JSON.parse(raw) : [];
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function odSaveQueue(queue) {
      localStorage.setItem(OD_QUEUE_KEY, JSON.stringify(queue));
    }

    function odEnqueueChange() {
      const queue = odLoadQueue();
      queue.push({ ts: Date.now() });
      odSaveQueue(queue);
      odUpdateSyncStatus();
    }

    function odClearQueue() {
      odSaveQueue([]);
    }

    function odEls() {
      return {
        details: document.getElementById("onedriveDetails"),
        clientId: document.getElementById("odClientId"),
        tenant: document.getElementById("odTenant"),
        redirectInput: document.getElementById("odRedirectInput"),
        filePath: document.getElementById("odFilePath"),
        status: document.getElementById("odStatus"),
        redirect: document.getElementById("odRedirectUri"),
        copyRedirect: document.getElementById("odCopyRedirect"),
        save: document.getElementById("odSave"),
        clear: document.getElementById("odClear"),
        signIn: document.getElementById("odSignIn"),
        signOut: document.getElementById("odSignOut"),
        syncNow: document.getElementById("odSyncNow"),
        exportBtn: document.getElementById("odExport"),
        importInput: document.getElementById("odImportInput"),
        syncState: document.getElementById("odSyncState"),
        lastSync: document.getElementById("odLastSync"),
        pendingCount: document.getElementById("odPendingCount"),
        lastError: document.getElementById("odLastError"),
      };
    }

    function odSetStatus(text) {
      const { status } = odEls();
      if (status) status.textContent = text;
    }

    function odUpdateUi() {
      const els = odEls();
      const hasSettings = !!(els.clientId?.value?.trim());
      const signedIn = !!odAccount;
      if (els.signOut) els.signOut.disabled = !signedIn;
      if (els.signIn) els.signIn.disabled = !hasSettings;
      if (els.syncNow) els.syncNow.disabled = !(signedIn && hasSettings);
    }

    function odInitUiDefaults() {
      const els = odEls();
      if (!els.redirect) return;
      els.redirect.textContent = odGetRedirectUriDefault();

      const saved = odLoadSettings() || {};
      if (saved?.clientId && els.clientId) els.clientId.value = saved.clientId;
      if (saved?.tenant && els.tenant) els.tenant.value = saved.tenant;
      if (els.redirectInput) els.redirectInput.value = saved.redirectUri || odGetRedirectUriDefault();
      if (els.filePath) els.filePath.value = saved.filePath || DEFAULT_FILE_PATH;

      odSetStatus("æœªæ¥ç¶š");
      odUpdateUi();
      const meta = odLoadSyncMeta();
      if (els.lastSync) els.lastSync.textContent = meta.lastSync || "-";
      if (els.lastError) els.lastError.textContent = meta.lastError || "-";
      odSetSyncState(navigator.onLine ? "å¾…æ©Ÿä¸­" : "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³");
      odUpdateSyncStatus();
    }

    function odBuildMsalConfig() {
      const els = odEls();
      const clientId = (els.clientId?.value || "").trim();
      if (!clientId) throw new Error("Client ID ãŒæœªè¨­å®šã§ã™ã€‚");
      const tenant = (els.tenant?.value || "").trim() || "common";
      const redirectUri = (els.redirectInput?.value || "").trim() || odGetRedirectUriDefault();
      return {
        auth: {
          clientId,
          authority: `https://login.microsoftonline.com/${tenant}`,
          redirectUri,
        },
        cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false },
        system: { allowNativeBroker: false },
      };
    }

    async function odEnsureMsal() {
      if (!window.msal || !window.msal.PublicClientApplication) {
        throw new Error("MSALãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ï¼ˆé€šä¿¡é®æ–­ã‹ã€CDNãŒæ­»ã‚“ã§ã‚‹ï¼‰ã€‚");
      }
      const config = odBuildMsalConfig();
      odMsalApp = new window.msal.PublicClientApplication(config);
      const accounts = odMsalApp.getAllAccounts();
      odAccount = accounts && accounts.length ? accounts[0] : null;
      odSetStatus(odAccount ? `æ¥ç¶š: ${odAccount.username}` : "æœªæ¥ç¶š");
      odUpdateUi();
    }

    async function odSignIn() {
      await odEnsureMsal();
      const result = await odMsalApp.loginPopup({ scopes: OD_SCOPES, prompt: "select_account" });
      odAccount = result.account || null;
      odSetStatus(odAccount ? `æ¥ç¶š: ${odAccount.username}` : "æœªæ¥ç¶š");
      odUpdateUi();
      await odFetchAndMergeRemote();
    }

    async function odSignOut() {
      if (!odMsalApp) await odEnsureMsal();
      const account = odAccount;
      odAccount = null;
      odUpdateUi();
      odSetStatus("æœªæ¥ç¶š");
      if (account) await odMsalApp.logoutPopup({ account });
    }

    async function odGetToken() {
      if (!odMsalApp) await odEnsureMsal();
      if (!odAccount) throw new Error("ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ã¾ã›ã‚“ã€‚");
      try {
        const r = await odMsalApp.acquireTokenSilent({ account: odAccount, scopes: OD_SCOPES });
        return r.accessToken;
      } catch (e) {
        const r = await odMsalApp.acquireTokenPopup({ scopes: OD_SCOPES });
        return r.accessToken;
      }
    }

    function odGetFilePath() {
      const els = odEls();
      const fromUi = (els.filePath?.value || "").trim();
      return fromUi || DEFAULT_FILE_PATH;
    }

    function odGetGraphFileUrl() {
      const path = odGetFilePath().replace(/^\/?Apps\//, "");
      const normalized = path.startsWith("/") ? path.slice(1) : path;
      const encodedPath = normalized.split("/").map(encodeURIComponent).join("/");
      return `https://graph.microsoft.com/v1.0/me/drive/special/approot:/${encodedPath}:/content`;
    }

    async function odGetRemoteData() {
      const token = await odGetToken();
      const url = odGetGraphFileUrl();
      const res = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });
      if (res.status === 404) {
        return { data: null, etag: null };
      }
      if (!res.ok) {
        const t = await res.text().catch(() => "");
        throw new Error(`OneDriveå–å¾—å¤±æ•—: ${res.status} ${t}`);
      }
      const etag = res.headers.get("ETag");
      const raw = await res.text();
      let data;
      try { data = JSON.parse(raw); } catch {
        throw new Error("OneDriveã®JSONãŒå£Šã‚Œã¦ã„ã¾ã™ã€‚");
      }
      return { data, etag };
    }

    async function odPutRemoteData(data, etag) {
      const token = await odGetToken();
      const url = odGetGraphFileUrl();
      const headers = {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json",
      };
      if (etag) headers["If-Match"] = etag;
      const res = await fetch(url, {
        method: "PUT",
        headers,
        body: JSON.stringify(data, null, 2)
      });
      if (res.status === 412) {
        throw new Error("etag_mismatch");
      }
      if (!res.ok) {
        const t = await res.text().catch(() => "");
        throw new Error(`OneDriveä¿å­˜å¤±æ•—: ${res.status} ${t}`);
      }
      odEtag = res.headers.get("ETag") || odEtag;
    }

    function normalizeEntry(entry) {
      // ã‚«ãƒ†ã‚´ãƒªãŒã€Œãã®ä»–ã€ã®å ´åˆã€å¼·åŒ–ã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§å†æ¨è«–ã‚’è©¦ã¿ã‚‹
      let category = normalizeCategory(entry.category || "");
      if (!category || category === "ãã®ä»–") {
        category = inferCategory(entry.text);
      }

      const normalized = {
        id: entry.id || uuid(),
        date: entry.date || "",
        text: entry.text || "",
        category: category,
        energy: entry.energy ?? null,
        mental: entry.mental ?? null,
        starred: !!entry.starred,
        tod: Array.isArray(entry.tod) ? entry.tod : [],
        ts: entry.ts || entry.updatedAt || 0,
        updatedAt: entry.updatedAt || entry.ts || 0,
        deleted: !!entry.deleted,
      };
      return normalized;
    }

    function normalizeMemo(memo) {
      return {
        id: memo.id || uuid(),
        text: memo.text || "",
        createdAt: memo.createdAt || Date.now(),
        updatedAt: memo.updatedAt || memo.createdAt || 0,
        done: !!memo.done,
        deleted: !!memo.deleted,
      };
    }

    function normalizeSimulation(sim) {
      return {
        id: sim.id || uuid(),
        createdAt: sim.createdAt || Date.now(),
        updatedAt: sim.updatedAt || sim.createdAt || 0,
        promptVersion: sim.promptVersion || "SEED_v5",
        logWindowDays: sim.logWindowDays || 90,
        recentCount: sim.recentCount || 30,
        inputDigest: sim.inputDigest || {},
        result: sim.result || {},
        commit: sim.commit || null,
        deleted: !!sim.deleted,
      };
    }

    const MAX_SIMULATION_HISTORY = 20;

    function mergeData(base, incoming) {
      // Schema migration: upgrade to v2 if needed
      const merged = { schemaVersion: 2, entries: [], memos: [], simulations: [] };

      const entryMap = new Map();
      [...(base?.entries || []), ...(incoming?.entries || [])].forEach(raw => {
        const e = normalizeEntry(raw);
        const existing = entryMap.get(e.id);
        if (!existing || e.updatedAt >= existing.updatedAt) {
          entryMap.set(e.id, e);
        }
      });
      merged.entries = Array.from(entryMap.values());

      const memoMap = new Map();
      [...(base?.memos || []), ...(incoming?.memos || [])].forEach(raw => {
        const m = normalizeMemo(raw);
        const existing = memoMap.get(m.id);
        if (!existing || m.updatedAt >= existing.updatedAt) {
          memoMap.set(m.id, m);
        }
      });
      merged.memos = Array.from(memoMap.values());

      // Simulations merge
      const simMap = new Map();
      console.groupCollapsed("ğŸ§© Simulation Merge Debug");
      [...(base?.simulations || []), ...(incoming?.simulations || [])].forEach(raw => {
        const s = normalizeSimulation(raw);
        const existing = simMap.get(s.id);

        if (existing) {
          const win = s.updatedAt >= existing.updatedAt;
          const log = `Compare [${s.id.slice(0, 4)}...]:\n` +
            `  Existing : del=${existing.deleted}, up=${new Date(existing.updatedAt).toISOString()} (${existing.updatedAt})\n` +
            `  Incoming : del=${s.deleted}, up=${new Date(s.updatedAt).toISOString()} (${s.updatedAt})\n` +
            `  Result   : ${win ? "Incoming Wins" : "Existing Keeps"}`;
          console.log(log);
          appendDebugLog(log);
        }

        if (!existing || s.updatedAt >= existing.updatedAt) {
          simMap.set(s.id, s);
        }
      });
      console.groupEnd();
      appendDebugLog(`Merge finished. Total: ${simMap.size} simulations (Filtered to ${MAX_SIMULATION_HISTORY})`);
      // Sort by createdAt desc and limit to MAX_SIMULATION_HISTORY
      const allSims = Array.from(simMap.values()).sort((a, b) => b.createdAt - a.createdAt);
      merged.simulations = allSims.slice(0, MAX_SIMULATION_HISTORY);

      // DailyStates merge (A-2 fix)
      merged.dailyStates = {};
      const baseStates = base?.dailyStates || {};
      const incStates = incoming?.dailyStates || {};
      const allDates = new Set([...Object.keys(baseStates), ...Object.keys(incStates)]);
      allDates.forEach(date => {
        const b = baseStates[date];
        const i = incStates[date];
        if (!b) {
          merged.dailyStates[date] = i;
        } else if (!i) {
          merged.dailyStates[date] = b;
        } else {
          // Both exist, take the newer one
          merged.dailyStates[date] = (b.updatedAt || 0) >= (i.updatedAt || 0) ? b : i;
        }
      });

      return merged;
    }

    async function odFetchAndMergeRemote() {
      if (!odAccount || !navigator.onLine) return;
      odSetSyncState("åŒæœŸä¸­...");
      try {
        const remote = await odGetRemoteData();
        odEtag = remote.etag || odEtag;
        if (remote.data) {
          dataCache = mergeData(remote.data, dataCache);
          odSaveCache(dataCache);
        } else {
          await odPutRemoteData(dataCache, null);
        }
        loadEntriesFromCache();
        loadNextMemosFromCache();
        renderAll();
        renderNextMemos();
        odMarkSynced();
      } catch (err) {
        odSetSyncError(err?.message || String(err));
      }
    }

    function odSetSyncState(state) {
      const els = odEls();
      if (els.syncState) els.syncState.textContent = state;
    }

    function odSetSyncError(message) {
      const els = odEls();
      if (els.lastError) els.lastError.textContent = message || "-";
      if (els.syncState) els.syncState.textContent = "ã‚¨ãƒ©ãƒ¼";
      const meta = odLoadSyncMeta();
      odSaveSyncMeta({ ...meta, lastError: message || "-" });
    }

    function odMarkSynced() {
      const els = odEls();
      const now = new Date();
      const lastSync = formatDateTimeForRecord(now);
      if (els.lastSync) els.lastSync.textContent = lastSync;
      if (els.lastError) els.lastError.textContent = "-";
      if (els.syncState) els.syncState.textContent = "åŒæœŸæ¸ˆã¿";
      odSaveSyncMeta({ lastSync, lastError: "-" });
    }

    function odUpdateSyncStatus() {
      const els = odEls();
      const queue = odLoadQueue();
      if (els.pendingCount) els.pendingCount.textContent = String(queue.length);
    }

    async function odFlushQueue() {
      if (!odAccount || !navigator.onLine) return;
      const queue = odLoadQueue();
      if (!queue.length) return;
      odSetSyncState("åŒæœŸä¸­...");
      try {
        const remote = await odGetRemoteData();
        odEtag = remote.etag || odEtag;
        if (remote.data) {
          const merged = mergeData(remote.data, dataCache);
          dataCache = merged;
          await odPutRemoteData(dataCache, odEtag);
        } else {
          await odPutRemoteData(dataCache, null);
        }
        odClearQueue();
        odSaveCache(dataCache);
        odMarkSynced();
        loadEntriesFromCache();
        loadNextMemosFromCache();
        renderAll();
        renderNextMemos();
      } catch (err) {
        if (err?.message === "etag_mismatch") {
          try {
            const latest = await odGetRemoteData();
            odEtag = latest.etag || odEtag;
            dataCache = mergeData(latest.data || { schemaVersion: 2, entries: [], memos: [], simulations: [] }, dataCache);
            await odPutRemoteData(dataCache, odEtag);
            odClearQueue();
            odSaveCache(dataCache);
            odMarkSynced();
          } catch (inner) {
            odSetSyncError(inner?.message || String(inner));
          }
        } else {
          odSetSyncError(err?.message || String(err));
        }
      }
      odUpdateSyncStatus();
    }

    async function odAutoConnect() {
      const settings = odLoadSettings();
      if (!settings?.clientId) return;
      try {
        await odEnsureMsal();
        if (odAccount && navigator.onLine) {
          await odFetchAndMergeRemote();
        }
      } catch (err) {
        odSetSyncError(err?.message || String(err));
      }
    }

    function storageLoadData() {
      const cached = odLoadCache();
      if (cached) {
        // Schema migration: ensure v2 structure
        if (!cached.schemaVersion || cached.schemaVersion < 2) {
          cached.schemaVersion = 2;
          cached.simulations = cached.simulations || [];
          cached.dailyStates = cached.dailyStates || {}; // A-2: æ—¥æ¬¡ãƒ¡ãƒ³ã‚¿ãƒ«ç”¨
        }
        // Normalize simulations (æŒ‡æ‘˜1,4å¯¾å¿œ: seedKey/assetCommitsä¿æŒ)
        if (cached.simulations) {
          cached.simulations = cached.simulations.map(sim => normalizeSimulation(sim));
        }
        dataCache = cached;
        return cached;
      }
      const fresh = { schemaVersion: 2, entries: [], memos: [], simulations: [], dailyStates: {} };
      dataCache = fresh;
      odSaveCache(fresh);
      return fresh;
    }

    // Simulationæ­£è¦åŒ–ï¼ˆseedKey/assetCommitsä¿æŒï¼‰
    function normalizeSimulation(sim) {
      return {
        id: sim.id || crypto.randomUUID(),
        seedKey: sim.seedKey || null,
        promptVersion: sim.promptVersion || 'unknown',
        result: sim.result || null,
        createdAt: sim.createdAt || Date.now(),
        updatedAt: sim.updatedAt || Date.now(),
        commit: sim.commit || null,
        assetCommits: sim.assetCommits || []
      };
    }

    function storageSaveData(newData) {
      dataCache = newData;
      odSaveCache(newData);
      odEnqueueChange();
      if (navigator.onLine) odFlushQueue();
    }

    function storageEnqueueChange() {
      odEnqueueChange();
    }

    function storageFlushQueue() {
      return odFlushQueue();
    }

    function migrateLegacyData() {
      const done = localStorage.getItem(OD_MIGRATION_KEY);
      if (done) return;
      const legacyEntriesRaw = localStorage.getItem(STORAGE_KEY);
      const legacyMemosRaw = localStorage.getItem(NEXT_MEMO_KEY);
      if (!legacyEntriesRaw && !legacyMemosRaw) {
        localStorage.setItem(OD_MIGRATION_KEY, "1");
        return;
      }
      let legacyEntries = [];
      let legacyMemos = [];
      try { legacyEntries = JSON.parse(legacyEntriesRaw || "[]"); } catch { legacyEntries = []; }
      try { legacyMemos = JSON.parse(legacyMemosRaw || "[]"); } catch { legacyMemos = []; }

      const mappedEntries = Array.isArray(legacyEntries)
        ? legacyEntries.map(raw => {
          const cleaned = cleanupLegacyEntry(raw);
          return {
            id: uuid(),
            date: cleaned.date || "",
            text: cleaned.text || "",
            category: normalizeCategory(cleaned.category || inferCategory(cleaned.text)),
            ts: parseRecordedAtToTs(cleaned.recordedAt) || Date.now(),
            updatedAt: Date.now(),
            deleted: false,
          };
        })
        : [];

      const mappedMemos = Array.isArray(legacyMemos)
        ? legacyMemos.map(m => {
          const createdAt = parseRecordedAtToTs(m.createdAt) || Date.now();
          return {
            id: uuid(),
            text: m.text || "",
            createdAt,
            updatedAt: createdAt,
            done: false,
            deleted: false,
          };
        })
        : [];

      dataCache = mergeData(dataCache, { schemaVersion: 2, entries: mappedEntries, memos: mappedMemos, simulations: [] });
      odSaveCache(dataCache);
      storageEnqueueChange();
      localStorage.setItem(OD_MIGRATION_KEY, "1");
    }

    function parseRecordedAtToTs(recordedAt) {
      if (!recordedAt) return null;
      if (typeof recordedAt === "number") return recordedAt;
      const match = recordedAt.match(/(\d{4})\/(\d{2})\/(\d{2})\s+(\d{2}):(\d{2})/);
      if (!match) return null;
      const [, y, m, d, hh, mm] = match.map(Number);
      return new Date(y, m - 1, d, hh, mm).getTime();
    }

    // ===== /OneDrive =====
    const CATEGORY_LIST = [
      "ä»•äº‹ãƒ»ä¼ç”»",
      "å®¶æ—ãƒ»å­ã©ã‚‚",
      "å¥åº·ãƒ»èº«ä½“",
      "ç’°å¢ƒãƒ»æš®ã‚‰ã—",
      "å­¦ã³ãƒ»å‹‰å¼·",
      "æŠ€è¡“ãƒ»é–‹ç™º",
      "ä»•è¾¼ã‚€ãƒ»å£²ã‚‹",
      "è¶£å‘³ãƒ»éŠã³",
      "å¿ƒãƒ»ãƒ¡ãƒ³ã‚¿ãƒ«",
      "ãã®ä»–"
    ];

    const CATEGORY_KEYWORDS = {
      "å®¶æ—ãƒ»å­ã©ã‚‚": [
        "å­ä¾›", "å­ã©ã‚‚", "æ¯å­", "å¨˜", "å®¶æ—", "å¥¥ã•ã‚“", "å¦»", "å«", "ãƒãƒ", "ãƒ‘ãƒ‘",
        "å…¬åœ’", "éŠã‚“ã ", "ä¸€ç·’ã«", "ãŠé¢¨å‘‚", "å¯ã‹ã—ã¤ã‘", "å®¿é¡Œ", "ãƒ—ãƒ¼ãƒ«", "é‹å‹•ä¼š",
        "å›½èª", "ç®—æ•°", "å‹‰å¼·ã‚’æ•™ãˆãŸ", "å­ä¾›ã¨"
      ],
      "å¥åº·ãƒ»èº«ä½“": [
        "ç¡çœ ", "çœ ã‚ŒãŸ", "é ­ç—›", "é‰„åˆ†", "æ­©ã„ãŸ", "æ­©ã‘ãŸ", "æ•£æ­©", "è‡ªç‚Š", "ã”é£¯", "æœé£Ÿ", "æ˜¼é£Ÿ", "å¤•é£Ÿ",
        "é£Ÿã¹ãŸ", "æ¤œè¨º", "ä½“é‡", "è‚¡é–¢ç¯€", "è…°", "ã‚¸ãƒ ", "é‹å‹•", "ã‚¹ãƒˆãƒ¬ãƒƒãƒ", "ãƒ—ãƒ©ãƒ³ã‚¯",
        "ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°", "ç­‹ãƒˆãƒ¬", "ã‚«ãƒ­ãƒªãƒ¼", "è¡€åœ§", "è–¬", "ç¡çœ è–¬", "æ—©ãèµ·ãã‚ŒãŸ", "æœæ—©ã",
        "ã‚¸ãƒ§ã‚®ãƒ³ã‚°", "æ˜¼æ•£æ­©", "æ­©", "2æ—¥é…”ã„", "å§¿å‹¢"
      ],
      "ç’°å¢ƒãƒ»æš®ã‚‰ã—": [
        "æœº", "æ¤…å­", "ã‚ªã‚¤ãƒ«ãƒ’ãƒ¼ã‚¿", "æš–æˆ¿", "è¦³è‘‰æ¤ç‰©", "ãƒ™ãƒ©ãƒ³ãƒ€", "ä»•äº‹éƒ¨å±‹",
        "éƒ¨å±‹", "ç‰‡ä»˜ã‘", "æƒé™¤", "ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ", "ç’°å¢ƒ", "ãƒ‡ã‚¹ã‚¯", "ã‚¤ã‚¹", "ç…§æ˜",
        "å†·è”µåº«", "æ´—æ¿¯", "åç´", "æ¨¡æ§˜æ›¿ãˆ", "å¼•ã£è¶Šã—", "æ•´ç†", "ç‰‡ã¥ã‘",
        "ãƒãƒƒãƒˆ", "æ£š", "ã‚¯ãƒƒã‚·ãƒ§ãƒ³", "ãƒ¢ãƒ‹ã‚¿"
      ],
      "ä»•äº‹ãƒ»ä¼ç”»": [
        "æ–°è¦äº‹æ¥­", "ä¼ç”»æ›¸", "ä¼ç”»æ¡ˆ", "ä¼ç”»éƒ¨é–€", "dx", "bpo", "æ¡ˆä»¶", "ztna",
        "éƒ¨é•·", "æœ¬éƒ¨é•·", "ä¸Šé•·", "ä¸Šå¸", "å–¶æ¥­", "ææ¡ˆ", "è¦‹ç©", "è³‡æ–™",
        "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ", "PJ", "ã‚­ãƒƒã‚¯ã‚ªãƒ•", "ä¼šè­°", "mtg", "æ‰“ã¡åˆã‚ã›", "1on1",
        "é¡§å®¢", "ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ", "å•†è«‡", "ãƒ—ãƒ¬ã‚¼ãƒ³", "ãƒ¬ãƒãƒ¼ãƒˆ", "èª¬æ˜è³‡æ–™",
        "ãƒãƒ¼ãƒ ", "å¾Œè¼©", "æ–°å’", "åŒåƒš", "è£½é€ ", "å”åŠ›ä¼šç¤¾", "é–¢é€£ä¼šç¤¾",
        "ã‚»ãƒ³ã‚¿ãƒ¼é•·", "ãƒãƒ¼ãƒ•", "é£²ã¿ä¼š", "å•†å“ä¼ç”»", "ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯"
      ],
      "å­¦ã³ãƒ»å‹‰å¼·": [
        "å‹‰å¼·", "å­¦ç¿’", "æ¤œå®š", "dxæ¤œå®š", "è©¦é¨“", "è³‡æ ¼", "å•é¡Œé›†", "æ–‡æ›¸æƒ…å ±ç®¡ç†å£«",
        "è¬›åº§", "ã‚»ãƒŸãƒŠãƒ¼", "å‹‰å¼·ä¼š", "æœ¬ã‚’èª­ã‚“ã ", "çŸ¥è­˜", "èª­æ›¸", "èª­ã‚“ã ",
        "è€³èª­", "ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹", "ç‘æƒ³", "å“²å­¦", "ã‚®ãƒ¼ã‚¯æ€è€ƒ"
      ],
      "æŠ€è¡“ãƒ»é–‹ç™º": [
        "chatgpt", "gpt", "codex", "canvas", "github", "ã‚¢ãƒ—ãƒª", "ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°",
        "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", "html", "javascript", "python", "vba", "vbs",
        "ollama", "gemma", "gemini", "ãƒ­ãƒ¼ã‚«ãƒ«llm", "ai", "ãƒã‚¤ãƒ–ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°",
        "ä½œã£ãŸ", "å°å…¥ã—ãŸ", "æ”¹ä¿®", "æ”¹é€ ", "ãƒ„ãƒ¼ãƒ«", "ã‚¹ãƒãƒ›ã§å‹•ã",
        "onedrive", "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰", "ã‚µãƒ¼ãƒ", "è‡ªå‹•èµ·å‹•"
      ],
      "ä»•è¾¼ã‚€ãƒ»å£²ã‚‹": [
        "æŠ•è³‡", "æ ª", "æ ªå¼", "nisa", "ã¤ã¿ãŸã¦", "ç©ç«‹", "ç©ã¿ç«‹ã¦", "è³‡ç”£", "è³‡ç”£å½¢æˆ",
        "è²¯é‡‘", "å®¶è¨ˆç°¿", "æ”¯å‡º", "åå…¥", "ãƒœãƒ¼ãƒŠã‚¹", "çµ¦æ–™", "å¹´å", "ä¿é™º",
        "åˆ©å›ã‚Š", "å£åº§", "ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹", "é…å½“", "æŠ•ä¿¡", "æŠ•è³‡ä¿¡è¨—", "é‡‘åˆ©", "å‚µåˆ¸",
        "ç¯€ç´„", "è¦ªè¶Šãˆ"
      ],
      "è¶£å‘³ãƒ»éŠã³": [
        "è¶£å‘³", "éŠã³", "ã‚²ãƒ¼ãƒ ", "switch", "ã‚¹ã‚¤ãƒƒãƒ", "ãƒã‚±ãƒ¢ãƒ³", "steam",
        "æ¼«ç”»", "ãƒãƒ³ã‚¬", "ã‚¢ãƒ‹ãƒ¡", "æ˜ ç”»", "ãƒ‰ãƒ©ãƒ", "æ—…è¡Œ", "æ¸©æ³‰",
        "ã‚­ãƒ£ãƒ³ãƒ—", "æ•£ç­–", "è¦³å…‰", "ã‚«ãƒ¡ãƒ©", "å†™çœŸ", "èª­æ›¸", "å°èª¬",
        "ãƒ©ãƒ¼ãƒ¡ãƒ³", "ã‚°ãƒ«ãƒ¡", "ã‚«ãƒ•ã‚§", "ãŠå‡ºã‹ã‘", "å£ç´™", "ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ",
        "ã‚¢ãƒƒãƒ—ãƒ«ãƒ‘ã‚¤", "ãƒ•ã‚£ãƒªãƒ³ã‚°", "çš„å½“ã¦", "è¡—ã‚³ãƒ­"
      ],
      "å¿ƒãƒ»ãƒ¡ãƒ³ã‚¿ãƒ«": [
        "æ°—åˆ†", "ãƒ¡ãƒ³ã‚¿ãƒ«", "è½ã¡è¾¼", "ä¸å®‰", "ã‚¹ãƒˆãƒ¬ã‚¹", "ãƒ¢ãƒ¤ãƒ¢ãƒ¤", "ã—ã‚“ã©", "ã¤ã‚‰ã„",
        "å®‰å¿ƒ", "ã»ã£ã¨ã—ãŸ", "ç·Šå¼µ", "ç–²ã‚ŒãŸ", "è‡ªå·±è‚¯å®šæ„Ÿ", "åŠ¹åŠ›æ„Ÿ", "ã‚„ã‚‹æ°—",
        "ã†ã‚Œã—ã‹ã£ãŸ", "ã†ã‚Œã—ã„", "æ¥½ã—ã‹ã£ãŸ", "ã‚¤ãƒ©ã‚¤ãƒ©", "ç„¦ã‚Š", "ãƒ¡ãƒ³ã‚¿ãƒ«ã‚±ã‚¢", "å¿ƒã®ä½™è£•",
        "ãƒ­ã‚°ã‚’ã‹ã‘ãŸ", "æ€’ã£ãŸã‚Šã—ãªã‹ã£ãŸ", "åˆ‡ã‚Œãšã«", "ç´”ç²‹ã«"
      ]
    };

    let entries = [];
    let nextMemos = [];

    function getActiveEntries() {
      return entries.filter(e => !e.deleted);
    }

    function deleteEntryById(id) {
      const target = entries.find(en => en.id === id);
      if (!target) return;
      target.deleted = true;
      target.updatedAt = Date.now();
      saveEntriesToStorage();
    }

    function parseDateStr(str) {
      const parts = str.split("-");
      if (parts.length !== 3) return null;
      const y = Number(parts[0]);
      const m = Number(parts[1]) - 1;
      const d = Number(parts[2]);
      return new Date(y, m, d);
    }

    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function formatDateTimeForRecord(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      const hh = String(date.getHours()).padStart(2, "0");
      const mm = String(date.getMinutes()).padStart(2, "0");
      return `${y}/${m}/${d} ${hh}:${mm}`;
    }

    function getRecordTime(entry) {
      const ts = entry.ts || entry.updatedAt || Date.now();
      return formatDateTimeForRecord(new Date(ts));
    }

    function getUniqueDatesFromEntries() {
      const set = new Set(getActiveEntries().map(e => e.date));
      return Array.from(set).filter(Boolean).sort();
    }

    function inferCategory(text) {
      const t = (text || "").toLowerCase();
      const scores = {};
      CATEGORY_LIST.forEach(cat => scores[cat] = 0);

      for (const [cat, words] of Object.entries(CATEGORY_KEYWORDS)) {
        words.forEach(w => {
          if (!w) return;
          const wLower = w.toLowerCase();
          if (t.includes(wLower)) scores[cat] += 1;
        });
      }

      let bestCat = "ãã®ä»–";
      let bestScore = 0;
      for (const cat of CATEGORY_LIST) {
        const s = scores[cat] || 0;
        if (s > bestScore) {
          bestScore = s;
          bestCat = cat;
        }
      }
      if (bestScore === 0) return "ãã®ä»–";
      return bestCat;
    }

    function normalizeCategory(cat) {
      if (!cat) return "ãã®ä»–";
      if (cat === "ãŠé‡‘ãƒ»æŠ•è³‡") return "ä»•è¾¼ã‚€ãƒ»å£²ã‚‹"; // Migration for legacy data
      if (CATEGORY_LIST.includes(cat)) return cat;
      if (cat === "ãã®ä»–" || cat === "ãã®ä»– ") return "ãã®ä»–";
      return "ãã®ä»–";
    }

    function cleanupLegacyEntry(raw) {
      let date = raw.date || raw["æ—¥ä»˜"] || "";
      let text = raw.text || raw["å†…å®¹"] || "";
      let recordedAt = raw.recordedAt || raw["è¨˜éŒ²æ—¥æ™‚"] || "";
      let category = raw.category || raw["ã‚«ãƒ†ã‚´ãƒª"] || "";

      const m = text.match(/^(.*?),(20\d{2}\/\d{2}\/\d{2} \d{2}:\d{2})(?:,(\d+))?(?:,(\d+))?.*$/);
      if (m) {
        text = m[1];
        if (!recordedAt || /^\d+$/.test(recordedAt)) {
          recordedAt = m[2];
        }
      }

      category = normalizeCategory(category || inferCategory(text));
      const obj = { date, text, recordedAt, category };
      return obj;
    }

    function countCategories(list) {
      const counts = {};
      CATEGORY_LIST.forEach(c => counts[c] = 0);
      list.forEach(e => {
        const c = normalizeCategory(e.category || inferCategory(e.text));
        counts[c] += 1;
      });
      return counts;
    }

    function computeMetrics() {
      const active = getActiveEntries();
      if (!active.length) {
        return { total: 0, weekly: 0, monthly: 0, weekStart: null, weekEnd: null, baseMonth: null };
      }
      const dates = getUniqueDatesFromEntries();
      const latestStr = dates[dates.length - 1];
      const latestDate = parseDateStr(latestStr);
      if (!latestDate) return { total: active.length, weekly: active.length, monthly: active.length };

      const baseYear = latestDate.getFullYear();
      const baseMonth = latestDate.getMonth();

      const day = latestDate.getDay();
      const diffToMonday = (day + 6) % 7;
      const weekStart = new Date(latestDate);
      weekStart.setDate(weekStart.getDate() - diffToMonday);
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);

      let weekly = 0;
      let monthly = 0;
      active.forEach(e => {
        const d = parseDateStr(e.date);
        if (!d) return;
        if (d >= weekStart && d <= weekEnd) weekly++;
        if (d.getFullYear() === baseYear && d.getMonth() === baseMonth) monthly++;
      });

      return { total: active.length, weekly, monthly, weekStart, weekEnd, baseMonth, baseYear };
    }

    function getEntriesForDate(dateStr) {
      return entries.filter(e => e.date === dateStr && !e.deleted);
    }

    function getEntriesInLastNDays(n) {
      const active = getActiveEntries();
      if (!active.length) return [];
      const dates = getUniqueDatesFromEntries();
      const latestStr = dates[dates.length - 1];
      const latestDate = parseDateStr(latestStr);
      if (!latestDate) return active.slice();
      const threshold = new Date(latestDate);
      threshold.setDate(threshold.getDate() - (n - 1));
      return active.filter(e => {
        const d = parseDateStr(e.date);
        return d && d >= threshold && d <= latestDate;
      });
    }

    function parseRawCsv(text) {
      const rows = [];
      let currentRow = [];
      let currentField = "";
      let inQuote = false;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const nextChar = text[i + 1];

        if (inQuote) {
          if (char === '"') {
            if (nextChar === '"') {
              currentField += '"';
              i++; // skip escaped quote
            } else {
              inQuote = false;
            }
          } else {
            currentField += char;
          }
        } else {
          if (char === '"') {
            inQuote = true;
          } else if (char === ',') {
            currentRow.push(currentField);
            currentField = "";
          } else if (char === '\r' || char === '\n') {
            if (char === '\r' && nextChar === '\n') {
              i++;
            }
            currentRow.push(currentField);
            rows.push(currentRow);
            currentRow = [];
            currentField = "";
          } else {
            currentField += char;
          }
        }
      }
      if (currentField || currentRow.length > 0) {
        currentRow.push(currentField);
        rows.push(currentRow);
      }
      return rows;
    }

    function parseIppoCsv(csvText) {
      // Use robust parser
      const rows = parseRawCsv(csvText);
      const result = [];
      let inEntries = false;

      for (let cols of rows) {
        if (cols.length === 0) continue;
        // ç©ºè¡Œãƒã‚§ãƒƒã‚¯ (1åˆ—ã§ç©ºæ–‡å­—)
        if (cols.length === 1 && !cols[0].trim()) continue;

        const col0 = (cols[0] || "").trim();

        if (!inEntries) {
          // ãƒ˜ãƒƒãƒ€ãƒ¼æ¤œå‡º: "æ—¥ä»˜" ã‚«ãƒ©ãƒ ãŒã‚ã‚Œã°é–‹å§‹
          if (col0 === "æ—¥ä»˜") {
            inEntries = true;
          }
          continue;
        }

        if (cols.length < 2) continue;

        const date = col0;
        const text = (cols[1] || "").trim();
        const recordedAt = (cols[2] || "").trim();

        if (!date || !text) continue;

        const entry = cleanupLegacyEntry({
          date,
          text,
          recordedAt,
          category: inferCategory(text)
        });

        let ts = parseRecordedAtToTs(entry.recordedAt);
        if (!ts && (entry.date || date)) {
          const d = new Date(entry.date || date);
          if (!isNaN(d.getTime())) ts = d.getTime();
        }
        ts = ts || Date.now();

        result.push({
          id: uuid(),
          date: entry.date || date,
          text: entry.text || text,
          category: normalizeCategory(entry.category || inferCategory(text)),
          ts: ts,
          updatedAt: Date.now(),
          deleted: false,
        });
      }

      return result;
    }

    function loadEntriesFromCache() {
      entries = (dataCache.entries || []).map(normalizeEntry);
    }

    function saveEntriesToStorage() {
      const normalized = entries.map(normalizeEntry);
      const deleted = normalized.filter(e => e.deleted);
      const active = normalized.filter(e => !e.deleted);
      dataCache.entries = [...deleted, ...active];
      storageSaveData(dataCache);
    }

    function loadNextMemosFromCache() {
      nextMemos = (dataCache.memos || []).map(normalizeMemo).filter(m => !m.done && !m.deleted);
    }

    function saveNextMemosToStorage(updatedMemo = null) {
      const memoMap = new Map();
      (dataCache.memos || []).map(normalizeMemo).forEach(m => memoMap.set(m.id, m));
      nextMemos.map(normalizeMemo).forEach(m => memoMap.set(m.id, m));
      if (updatedMemo) {
        const normalized = normalizeMemo(updatedMemo);
        memoMap.set(normalized.id, normalized);
      }
      dataCache.memos = Array.from(memoMap.values());
      storageSaveData(dataCache);
    }

    function renderNextMemos() {
      const listEl = document.getElementById("nextMemoList");
      const emptyEl = document.getElementById("nextMemoEmpty");
      if (!listEl || !emptyEl) return;

      listEl.innerHTML = "";
      if (!nextMemos.length) {
        emptyEl.style.display = "";
        return;
      }
      emptyEl.style.display = "none";

      nextMemos.forEach(memo => {
        const li = document.createElement("li");
        li.className = "next-memo-item";

        const label = document.createElement("label");
        label.className = "next-memo-label";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "next-memo-check";

        const textWrap = document.createElement("div");
        const textSpan = document.createElement("span");
        textSpan.className = "next-memo-text";
        textSpan.textContent = memo.text;

        const meta = document.createElement("div");
        meta.className = "next-memo-meta";
        meta.textContent = memo.createdAt ? `è¿½åŠ : ${formatDateTimeForRecord(new Date(memo.createdAt))}` : "";

        textWrap.appendChild(textSpan);
        if (memo.createdAt) textWrap.appendChild(meta);

        label.appendChild(checkbox);
        label.appendChild(textWrap);

        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "btn-ghost-small";
        delBtn.textContent = "å‰Šé™¤";

        checkbox.addEventListener("change", () => {
          if (!checkbox.checked) return;
          const ok = window.confirm("ã“ã®ãƒ¡ãƒ¢ã¯ã€çµ‚ã‚ã£ãŸã€ã¨ã—ã¦å‰Šé™¤ã—ã¦å¤§ä¸ˆå¤«ï¼Ÿ");
          if (!ok) {
            checkbox.checked = false;
            return;
          }
          memo.done = true;
          memo.updatedAt = Date.now();
          nextMemos = nextMemos.filter(x => x.id !== memo.id);
          saveNextMemosToStorage(memo);
          renderNextMemos();
        });

        delBtn.addEventListener("click", () => {
          const ok = window.confirm("ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
          if (!ok) return;
          memo.deleted = true;
          memo.updatedAt = Date.now();
          nextMemos = nextMemos.filter(x => x.id !== memo.id);
          saveNextMemosToStorage(memo);
          renderNextMemos();
        });

        li.appendChild(label);
        li.appendChild(delBtn);
        listEl.appendChild(li);
      });
    }

    function renderDateSelect() {
      const select = document.getElementById("dateSelect");
      const dates = getUniqueDatesFromEntries();
      select.innerHTML = "";
      if (!dates.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "-";
        select.appendChild(opt);
        return;
      }
      const sortedDesc = dates.slice().sort().reverse();
      sortedDesc.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        select.appendChild(opt);
      });
      const current = select.getAttribute("data-current");
      if (current && sortedDesc.includes(current)) select.value = current;
      else {
        select.value = sortedDesc[0];
        select.setAttribute("data-current", sortedDesc[0]);
      }
    }

    function renderDiaryForDate(dateStr) {
      const out = document.getElementById("diaryOutput");
      const msg = document.getElementById("diaryMessage");

      if (!getActiveEntries().length || !dateStr || dateStr === "-") {
        out.value = "";
        msg.textContent = "ä¸€æ­©ãŒãªã„ã®ã§ã€ã“ã®æ—¥ã®è‡ªå‹•æ—¥è¨˜ã¯ã¾ã ä½œã‚Œã¾ã›ã‚“ã€‚";
        return;
      }

      const list = getEntriesForDate(dateStr);
      if (!list.length) {
        out.value = "";
        msg.textContent = "ä¸€æ­©ãŒãªã„ã®ã§ã€ã“ã®æ—¥ã®è‡ªå‹•æ—¥è¨˜ã¯ã¾ã ä½œã‚Œã¾ã›ã‚“ã€‚";
        return;
      }

      const counts = countCategories(list);
      const total = list.length;
      const nonZeroCats = CATEGORY_LIST.filter(cat => counts[cat] > 0);
      const topCats = nonZeroCats
        .slice()
        .sort((a, b) => (counts[b] || 0) - (counts[a] || 0))
        .slice(0, 3);

      const withTime = list
        .slice()
        .map(e => {
          const rec = getRecordTime(e);
          let hour = null;
          const parts = rec.split(" ");
          if (parts.length >= 2) {
            const t = parts[1];
            const hh = t.split(":")[0];
            const hNum = Number(hh);
            if (!Number.isNaN(hNum)) hour = hNum;
          }
          return { entry: e, hour };
        })
        .sort((a, b) => getRecordTime(a.entry).localeCompare(getRecordTime(b.entry)));

      const morning = [];
      const afternoon = [];
      const night = [];

      withTime.forEach(obj => {
        const h = obj.hour;
        if (h == null) {
          afternoon.push(obj.entry);
        } else if (h < 12) {
          morning.push(obj.entry);
        } else if (h < 18) {
          afternoon.push(obj.entry);
        } else {
          night.push(obj.entry);
        }
      });

      const lines = [];

      lines.push(`ã€${dateStr}ã®ãµã‚Šã‹ãˆã‚Šã€‘`);
      lines.push("");
      lines.push(`ä»Šæ—¥ã¯ã€Œä¸€æ­©ã€ã‚’${total}ä»¶ã€‚`);

      if (topCats.length === 1) {
        lines.push(`ç‰¹ã« ${topCats[0]} ã¾ã‚ã‚Šã§å‹•ããŒå¤šã‹ã£ãŸä¸€æ—¥ã€‚`);
      } else if (topCats.length === 2) {
        lines.push(`ç‰¹ã« ${topCats[0]} ã¨ ${topCats[1]} ã‚ãŸã‚Šã§å‹•ããŒå¤šã‹ã£ãŸä¸€æ—¥ã€‚`);
      } else if (topCats.length >= 3) {
        lines.push(
          `ç‰¹ã« ${topCats[0]}ãƒ»${topCats[1]}ãƒ»${topCats[2]} ã‚ãŸã‚Šã«ã€ã˜ã‚ã˜ã‚ã¨å‰é€²ãŒç©ã¿ä¸ŠãŒã£ãŸã€‚`
        );
      }

      function addSlotParagraph(label, arr) {
        if (!arr.length) return;
        const picked = arr.slice(0, 2);
        const quoted = picked.map(e => `ã€Œ${e.text}ã€`).join("ã€");
        lines.push("");
        lines.push(`${label}ã¯ã€${quoted} ã¨ã„ã£ãŸä¸€æ­©ã‚’è¸ã‚“ã æ™‚é–“å¸¯ã€‚`);
      }

      const anySlot =
        morning.length > 0 || afternoon.length > 0 || night.length > 0;

      if (anySlot) {
        addSlotParagraph("åˆå‰ä¸­", morning);
        addSlotParagraph("åˆå¾Œ", afternoon);
        addSlotParagraph("å¤œã¯", night);
      } else {
        const picked = list.slice(0, 3);
        const quoted = picked.map(e => `ã€Œ${e.text}ã€`).join("ã€");
        lines.push("");
        lines.push(`ä¸€æ—¥ã‚’é€šã—ã¦ã€${quoted} ã¨ã„ã£ãŸä¸€æ­©ãŒç©ã¿ä¸ŠãŒã£ãŸã€‚`);
      }

      lines.push("");
      lines.push("ã€ä»Šæ—¥ã®ãƒ¡ãƒ¢ã€‘");
      lines.push("ãƒ»ã†ã¾ãã„ã£ãŸï¼é€²ã‚“ã ã¨æ„Ÿã˜ãŸã“ã¨ï¼š");
      lines.push("ãƒ»ã¡ã‚‡ã£ã¨å¼•ã£ã‹ã‹ã£ã¦ã„ã‚‹ã“ã¨ï¼š");
      lines.push("ãƒ»æ˜æ—¥ã‚‚ã†ä¸€æ­©ã ã‘ç¶šã‘ã‚‹ãªã‚‰ï¼š");

      lines.push("");
      lines.push("ã€æ˜æ—¥ã®è‡ªåˆ†ã¸ã®ã²ã¨ã“ã¨ã€‘");
      lines.push("ï¼Šã“ã“ã«ã²ã¨ã“ã¨ãƒ¡ãƒ¢ã‚’æ›¸ãï¼ˆä¾‹ï¼šã€ä»Šæ—¥ã®ç¶šãã®ã“ã“ã ã‘ã‚„ã‚‹ã€ã€ç„¡ç†ã—ã™ããªã„ã€ãªã©ï¼‰");

      out.value = lines.join("\n");
      msg.textContent = "æ™‚é–“å¸¯ã¨ã‚«ãƒ†ã‚´ãƒªã‚’ã–ã£ãã‚Šã¾ã¨ã‚ãŸã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®æ—¥è¨˜ãƒ‰ãƒ©ãƒ•ãƒˆã€‚ä¸­èº«ã¯è‡ªç”±ã«è¿½è¨˜ãƒ»ä¿®æ­£OKã€‚";
    }

    function renderDailyTable(dateStr) {
      const tbody = document.getElementById("dailyTbody");
      const label = document.getElementById("selectedDateLabel");
      const countLabel = document.getElementById("dailyCountLabel");
      const scoreEl = document.getElementById("dailyScore");
      const wrap = document.getElementById("dailyTableWrap");
      const empty = document.getElementById("noDataDaily");

      if (!getActiveEntries().length || !dateStr || dateStr === "-") {
        wrap.style.display = "none";
        empty.style.display = "";
        label.textContent = "-";
        countLabel.textContent = "0ä»¶";
        scoreEl.textContent = "0.0";
        renderDiaryForDate("-");
        return;
      }

      const list = getEntriesForDate(dateStr);
      label.textContent = dateStr || "-";
      countLabel.textContent = list.length + "ä»¶";

      const score = Math.min(list.length * 0.2, 5);
      scoreEl.textContent = score.toFixed(1);

      tbody.innerHTML = "";
      list.slice()
        .sort((a, b) => getRecordTime(a).localeCompare(getRecordTime(b)))
        .forEach(e => {
          const tr = document.createElement("tr");

          const tdTime = document.createElement("td");
          const timePart = getRecordTime(e).split(" ")[1] || "";
          tdTime.textContent = timePart;
          tr.appendChild(tdTime);

          // B-2: æœæ˜¼å¤œTODã‚«ãƒ©ãƒ ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰
          const tdTod = document.createElement("td");
          tdTod.style.whiteSpace = "nowrap";
          const todWrap = document.createElement("div");
          todWrap.className = "tod-wrap";

          const tods = [
            { key: "morning", icon: "ğŸŒ…", label: "æœ" },
            { key: "afternoon", icon: "â˜€ï¸", label: "æ˜¼" },
            { key: "night", icon: "ğŸŒ™", label: "å¤œ" }
          ];

          tods.forEach(t => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.textContent = t.icon;
            btn.title = t.label;
            btn.className = "btn-tod" + ((e.tod || []).includes(t.key) ? " active" : "");
            btn.addEventListener("click", () => {
              e.tod = e.tod || [];
              if (e.tod.includes(t.key)) {
                e.tod = e.tod.filter(k => k !== t.key);
              } else {
                e.tod.push(t.key);
              }
              e.updatedAt = Date.now();
              saveEntriesToStorage();

              // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã ã‘æ›´æ–°ï¼ˆå†æç”»ã¯é‡ã„ã®ã§é¿ã‘ã‚‹ï¼‰
              btn.className = "btn-tod" + (e.tod.includes(t.key) ? " active" : "");
            });
            todWrap.appendChild(btn);
          });
          tdTod.appendChild(todWrap);
          // tr.appendChild(tdTod); // ç§»å‹•

          const tdText = document.createElement("td");
          tdText.className = "entry-text";
          tdText.textContent = e.text;
          tr.appendChild(tdText);

          const tdCat = document.createElement("td");
          const selectCat = document.createElement("select");
          selectCat.className = "category-select";

          CATEGORY_LIST.forEach(catName => {
            const opt = document.createElement("option");
            opt.value = catName;
            opt.textContent = catName;
            selectCat.appendChild(opt);
          });

          const currentCat = normalizeCategory(e.category || inferCategory(e.text));
          selectCat.value = currentCat;

          selectCat.addEventListener("change", () => {
            e.category = selectCat.value;
            e.updatedAt = Date.now();
            saveEntriesToStorage();
            renderMetrics();
            renderCategoryBars();
            const select = document.getElementById("dateSelect");
            renderDiaryForDate(select.value);
          });

          tdCat.appendChild(selectCat);
          tr.appendChild(tdCat);
          tr.appendChild(tdTod); // ã“ã“ã«ç§»å‹•

          const tdAction = document.createElement("td");
          tdAction.style.whiteSpace = "nowrap";

          // ã‚¹ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆå‰å¤§ãªä¸€æ­©ãƒãƒ¼ã‚¯ï¼‰
          const starBtn = document.createElement("button");
          starBtn.type = "button";
          starBtn.textContent = e.starred ? "â˜…" : "â˜†";
          starBtn.className = "btn-star" + (e.starred ? " starred" : "");
          starBtn.title = e.starred ? "å‰å¤§ãªä¸€æ­©ãƒãƒ¼ã‚¯ã‚’è§£é™¤" : "å‰å¤§ãªä¸€æ­©ã¨ã—ã¦ãƒãƒ¼ã‚¯";
          starBtn.addEventListener("click", () => {
            const target = entries.find(en => en.id === e.id);
            if (target) {
              target.starred = !target.starred;
              target.updatedAt = Date.now();
              saveEntriesToStorage();
              const select = document.getElementById("dateSelect");
              renderDailyTable(select.value);
            }
          });
          tdAction.appendChild(starBtn);

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.textContent = "å‰Šé™¤";
          delBtn.className = "btn-danger";
          delBtn.addEventListener("click", () => {
            const ok = window.confirm("ã“ã®ä¸€æ­©ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
            if (!ok) return;
            deleteEntryById(e.id);
            renderAll();
          });
          tdAction.appendChild(delBtn);
          tr.appendChild(tdAction);

          tbody.appendChild(tr);
        });

      wrap.style.display = "";
      empty.style.display = "none";

      // B-3: æ—¥æ¬¡ãƒ¡ãƒ³ã‚¿ãƒ«UIæ›´æ–°
      const dailyState = (dataCache.dailyStates || {})[dateStr] || {};
      const currentMental = dailyState.mental;
      document.querySelectorAll("#dailyMentalBtns .rating-btn").forEach(btn => {
        btn.classList.toggle("selected", parseInt(btn.dataset.value) === currentMental);
      });

      renderDiaryForDate(dateStr);
    }

    function renderMetrics() {
      const m = computeMetrics();
      document.getElementById("metricTotal").textContent = m.total;
      document.getElementById("metricWeekly").textContent = m.weekly;
      document.getElementById("metricMonthly").textContent = m.monthly;

      const subtitle = document.getElementById("metricsSubtitle");
      const weeklyRange = document.getElementById("metricWeeklyRange");

      if (!getActiveEntries().length || !m.weekStart || !m.weekEnd) {
        subtitle.textContent = "ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“";
        weeklyRange.textContent = "-";
        return;
      }
      const ws = formatDate(m.weekStart);
      const we = formatDate(m.weekEnd);
      subtitle.textContent = `æœ€æ–°ã®æ—¥ä»˜ã‚’åŸºæº–ã«é›†è¨ˆï¼ˆé€±ï¼š${ws}ã€œ${we}ï¼‰`;
      weeklyRange.textContent = `${ws}ã€œ${we}`;
    }

    function renderCategoryBars() {
      const container = document.getElementById("categoryBars");
      const empty = document.getElementById("noCategory");

      if (!getActiveEntries().length) {
        container.innerHTML = "";
        empty.style.display = "";
        return;
      }
      const lastList = getEntriesInLastNDays(7);
      const counts = countCategories(lastList);
      const max = Math.max(...Object.values(counts));

      container.innerHTML = "";
      CATEGORY_LIST.forEach(cat => {
        const c = counts[cat] || 0;

        const wrap = document.createElement("div");
        wrap.className = "category-bar";

        const header = document.createElement("div");
        header.className = "category-bar-header";

        const left = document.createElement("span");
        left.textContent = cat;
        const right = document.createElement("span");
        right.textContent = c + "ä»¶";

        header.appendChild(left);
        header.appendChild(right);

        const barOuter = document.createElement("div");
        barOuter.className = "category-bar-fill";
        const barInner = document.createElement("span");
        barInner.style.width = max > 0 ? (c / max * 100).toFixed(1) + "%" : "0%";
        barOuter.appendChild(barInner);

        wrap.appendChild(header);
        wrap.appendChild(barOuter);
        container.appendChild(wrap);
      });

      empty.style.display = "none";
    }

    function renderAll() {
      renderMetrics();
      renderCategoryBars();

      renderDateSelect();
      const dates = getUniqueDatesFromEntries();
      const select = document.getElementById("dateSelect");
      let targetDate = select.value;
      if (!targetDate && dates.length) {
        targetDate = dates[dates.length - 1];
        select.value = targetDate;
      }
      if (targetDate) renderDailyTable(targetDate);
      else renderDailyTable("-");

      renderCrossTodChart();
    }

    function toCsv(rows) {
      return rows.map(cols => cols.map(c => {
        const s = (c == null) ? "" : String(c);
        if (s.includes('"') || s.includes(",") || s.includes("\n") || s.includes("\r")) {
          return '"' + s.replace(/"/g, '""') + '"';
        }
        return s;
      }).join(",")).join("\r\n");
    }

    function downloadCsv(filename, rows) {
      if (!rows || !rows.length) {
        alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }
      const csvText = toCsv(rows);
      const blob = new Blob([csvText], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function buildMonthlySummaryRows() {
      if (!getActiveEntries().length) return [];
      const monthMap = {};
      getActiveEntries().forEach(e => {
        const dateStr = e.date || "";
        if (!dateStr) return;
        const month = dateStr.slice(0, 7);
        const cat = normalizeCategory(e.category || inferCategory(e.text));
        if (!monthMap[month]) monthMap[month] = {};
        if (!monthMap[month][cat]) monthMap[month][cat] = 0;
        monthMap[month][cat]++;
      });

      const months = Object.keys(monthMap).sort();
      const rows = [["æœˆ", "ã‚«ãƒ†ã‚´ãƒª", "ä»¶æ•°"]];
      months.forEach(m => {
        CATEGORY_LIST.forEach(cat => {
          const count = monthMap[m][cat] || 0;
          if (count > 0) rows.push([m, cat, count]);
        });
      });
      return rows;
    }

    function buildAllEntriesRows() {
      if (!getActiveEntries().length) return [];
      const rows = [["æ—¥ä»˜", "ä¸€æ­©ã®å†…å®¹", "è¨˜éŒ²æ—¥æ™‚", "ã‚«ãƒ†ã‚´ãƒª"]];
      const sorted = getActiveEntries().slice().sort((a, b) => {
        const ka = (a.date || "") + " " + getRecordTime(a);
        const kb = (b.date || "") + " " + getRecordTime(b);
        return ka.localeCompare(kb);
      });
      sorted.forEach(e => {
        rows.push([
          e.date || "",
          e.text || "",
          getRecordTime(e),
          normalizeCategory(e.category || inferCategory(e.text))
        ]);
      });
      return rows;
    }

    function downloadJson() {
      const payload = JSON.stringify(dataCache, null, 2);
      const blob = new Blob([payload], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ippo_data.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    async function importJsonFile(file) {
      const text = await file.text();
      let parsed;
      try { parsed = JSON.parse(text); } catch {
        alert("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        return;
      }
      if (!parsed || !Array.isArray(parsed.entries) || !Array.isArray(parsed.memos)) {
        alert("JSONå½¢å¼ãŒé•ã„ã¾ã™ã€‚");
        return;
      }
      dataCache = mergeData(dataCache, parsed);
      odSaveCache(dataCache);
      storageEnqueueChange();
      loadEntriesFromCache();
      loadNextMemosFromCache();
      renderAll();
      renderNextMemos();
      if (navigator.onLine) storageFlushQueue();
    }

    function setupEvents() {
      // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
      const tabBtns = document.querySelectorAll(".tab-btn");
      const tabContents = document.querySelectorAll(".tab-content");
      tabBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.tab;
          tabBtns.forEach(b => b.classList.remove("active"));
          tabContents.forEach(c => c.classList.remove("active"));
          btn.classList.add("active");
          const targetEl = document.getElementById(target === "ippo" ? "tabIppo" : "tabFuture");
          if (targetEl) targetEl.classList.add("active");
        });
      });

      // ä½“åŠ›ãƒ»ãƒ¡ãƒ³ã‚¿ãƒ«è©•ä¾¡ãƒœã‚¿ãƒ³
      let currentEnergy = null;
      let currentMental = null;

      function setupRatingBtns(containerId, clearId, getValue, setValue) {
        const container = document.getElementById(containerId);
        const clearBtn = document.getElementById(clearId);
        if (!container) return;

        container.querySelectorAll(".rating-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const val = parseInt(btn.dataset.value, 10);
            container.querySelectorAll(".rating-btn").forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");
            setValue(val);
          });
        });

        if (clearBtn) {
          clearBtn.addEventListener("click", () => {
            container.querySelectorAll(".rating-btn").forEach(b => b.classList.remove("selected"));
            setValue(null);
          });
        }
      }

      setupRatingBtns("energyBtns", "energyClear", () => currentEnergy, v => currentEnergy = v);
      setupRatingBtns("mentalBtns", "mentalClear", () => currentMental, v => currentMental = v);

      // æ—¥ä»˜ã‚»ãƒ¬ã‚¯ãƒˆ
      const select = document.getElementById("dateSelect");
      select.addEventListener("change", () => {
        const v = select.value;
        select.setAttribute("data-current", v);
        renderDailyTable(v);
      });

      const csvInput = document.getElementById("csvInput");
      const fileStatus = document.getElementById("fileStatus");
      csvInput.addEventListener("change", (ev) => {
        const file = ev.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result;
          const parsed = parseIppoCsv(text);
          if (!parsed.length) {
            fileStatus.textContent = "CSVã‚’èª­ã¿è¾¼ã‚“ã ãŒã€ã‚¨ãƒ³ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
            fileStatus.style.color = "#f97373";
            return;
          }
          entries = parsed;
          saveEntriesToStorage();
          fileStatus.textContent = `${file.name} ã‹ã‚‰ ${entries.length}ä»¶ èª­ã¿è¾¼ã¿æ¸ˆã¿`;
          fileStatus.style.color = "#9ca3af";
          renderAll();
        };
        reader.onerror = () => {
          fileStatus.textContent = "CSVèª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
          fileStatus.style.color = "#f97373";
        };
        reader.readAsText(file, "UTF-8");
      });

      const addForm = document.getElementById("addForm");
      const addText = document.getElementById("addText");
      addText.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter" && !ev.shiftKey) {
          ev.preventDefault();
          document.getElementById("addForm").dispatchEvent(new Event("submit"));
        }
      });
      const addDate = document.getElementById("addDate");
      const addMsg = document.getElementById("addMessage");

      addForm.addEventListener("submit", (ev) => {
        ev.preventDefault();
        const text = (addText.value || "").trim();
        let dateStr = addDate.value;
        if (!text) {
          addMsg.textContent = "ä¸€æ­©ã®å†…å®¹ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚";
          addMsg.className = "message err";
          return;
        }
        if (!dateStr) dateStr = formatDate(new Date());

        const now = new Date();
        const entry = {
          id: uuid(),
          date: dateStr,
          text: text,
          category: inferCategory(text),
          tod: [],
          ts: now.getTime(),
          updatedAt: now.getTime(),
          deleted: false,
        };

        entries.push(entry);
        entries.sort((a, b) => {
          const ka = (a.date || "") + " " + getRecordTime(a);
          const kb = (b.date || "") + " " + getRecordTime(b);
          return ka.localeCompare(kb);
        });
        saveEntriesToStorage();

        addText.value = "";
        // è©•ä¾¡ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        currentEnergy = null;
        currentMental = null;
        document.querySelectorAll("#energyBtns .rating-btn, #mentalBtns .rating-btn").forEach(b => b.classList.remove("selected"));

        addMsg.textContent = "ä¸€æ­©ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚";
        addMsg.className = "message ok";

        renderAll();
        const select = document.getElementById("dateSelect");
        select.value = dateStr;
        select.setAttribute("data-current", dateStr);
        renderDailyTable(dateStr);
      });

      const today = new Date();
      addDate.value = formatDate(today);

      const resetBtn = document.getElementById("resetButton");
      resetBtn.addEventListener("click", () => {
        const ok = window.confirm("ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ä¸€æ­©ãƒ­ã‚°ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ");
        if (!ok) return;

        entries = [];
        nextMemos = [];
        dataCache = { schemaVersion: 1, entries: [], memos: [] };
        odSaveCache(dataCache);
        storageEnqueueChange();

        const fileStatus = document.getElementById("fileStatus");
        fileStatus.textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ";
        fileStatus.style.color = "#f97373";

        document.getElementById("dailyTbody").innerHTML = "";
        document.getElementById("dailyTableWrap").style.display = "none";
        document.getElementById("noDataDaily").style.display = "";
        document.getElementById("selectedDateLabel").textContent = "-";
        document.getElementById("dailyCountLabel").textContent = "0ä»¶";
        document.getElementById("dailyScore").textContent = "0.0";

        renderAll();
        renderDiaryForDate("-");
        renderNextMemos();
      });

      document.getElementById("exportMonthlyBtn").addEventListener("click", () => {
        const rows = buildMonthlySummaryRows();
        downloadCsv("ippo-monthly-summary.csv", rows);
      });

      document.getElementById("exportAllBtn").addEventListener("click", () => {
        const rows = buildAllEntriesRows();
        downloadCsv("ippo-all-entries.csv", rows);
      });

      // B-3: æ—¥æ¬¡ãƒ¡ãƒ³ã‚¿ãƒ«UIã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById("dailyMentalBtns").addEventListener("click", (e) => {
        if (!e.target.classList.contains("rating-btn")) return;
        const val = parseInt(e.target.dataset.value);
        const dateSelect = document.getElementById("dateSelect");
        const dateStr = dateSelect.value;
        if (!dateStr || dateStr === "-") return;

        dataCache.dailyStates = dataCache.dailyStates || {};
        if (!dataCache.dailyStates[dateStr]) dataCache.dailyStates[dateStr] = {};

        dataCache.dailyStates[dateStr].mental = val;
        dataCache.dailyStates[dateStr].updatedAt = Date.now();
        storageSaveData(dataCache);

        // UIæ›´æ–°
        document.querySelectorAll("#dailyMentalBtns .rating-btn").forEach(btn => {
          btn.classList.toggle("selected", parseInt(btn.dataset.value) === val);
        });

        // ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ï¼ˆæœªæ¥ãƒ©ãƒœï¼‰
        renderFlowChart();
      });

      document.getElementById("dailyMentalClear").addEventListener("click", () => {
        const dateSelect = document.getElementById("dateSelect");
        const dateStr = dateSelect.value;
        if (!dateStr || dateStr === "-") return;

        if (dataCache.dailyStates && dataCache.dailyStates[dateStr]) {
          delete dataCache.dailyStates[dateStr].mental;
          dataCache.dailyStates[dateStr].updatedAt = Date.now();
          storageSaveData(dataCache);
        }

        // UIæ›´æ–°
        document.querySelectorAll("#dailyMentalBtns .rating-btn").forEach(btn => {
          btn.classList.remove("selected");
        });

        // ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
        renderFlowChart();
      });

      const regenDiaryBtn = document.getElementById("regenerateDiaryBtn");
      const copyDiaryBtn = document.getElementById("copyDiaryBtn");
      const diaryMsg = document.getElementById("diaryMessage");

      regenDiaryBtn.addEventListener("click", () => {
        const select = document.getElementById("dateSelect");
        const dateStr = select.value;
        renderDiaryForDate(dateStr);
      });

      copyDiaryBtn.addEventListener("click", async () => {
        const out = document.getElementById("diaryOutput");
        const text = out.value || "";
        if (!text.trim()) {
          diaryMsg.textContent = "ã‚³ãƒ”ãƒ¼ã™ã‚‹æ—¥è¨˜ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
          return;
        }
        try {
          await navigator.clipboard.writeText(text);
          diaryMsg.textContent = "ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚";
        } catch (err) {
          diaryMsg.textContent = "ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚";
        }
      });

      const memoForm = document.getElementById("nextMemoForm");
      const memoInput = document.getElementById("nextMemoInput");
      if (memoForm && memoInput) {
        memoForm.addEventListener("submit", (ev) => {
          ev.preventDefault();
          const text = (memoInput.value || "").trim();
          if (!text) return;

          const now = new Date();
          const memo = { id: uuid(), text, createdAt: now.getTime(), updatedAt: now.getTime(), done: false };
          nextMemos.push(memo);
          saveNextMemosToStorage();
          memoInput.value = "";
          renderNextMemos();
        });
      }

      initOneDriveEvents();
    }

    function initOneDriveEvents() {
      const els = odEls();
      if (!els.details) return;

      odInitUiDefaults();

      els.copyRedirect?.addEventListener("click", async () => {
        const txt = odGetRedirectUriDefault();
        try {
          await navigator.clipboard.writeText(txt);
          alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
        } catch {
          const ta = document.createElement("textarea");
          ta.value = txt;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
          alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
        }
      });

      els.save?.addEventListener("click", () => {
        const clientId = (els.clientId?.value || "").trim();
        const tenant = (els.tenant?.value || "").trim();
        const redirectUri = (els.redirectInput?.value || "").trim() || odGetRedirectUriDefault();
        const filePath = (els.filePath?.value || "").trim() || DEFAULT_FILE_PATH;
        if (!clientId) {
          alert("Client ID ã‚’å…¥ã‚Œã¦ã‹ã‚‰ä¿å­˜ã—ã¦ã€‚");
          return;
        }
        odSaveSettings({ clientId, tenant, redirectUri, filePath });
        odSetStatus("è¨­å®šä¿å­˜ï¼ˆæœªæ¥ç¶šï¼‰");
        odUpdateUi();
      });

      els.clear?.addEventListener("click", () => {
        if (!confirm("OneDriveè¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ï¼Ÿ")) return;
        odClearSettings();
        if (els.clientId) els.clientId.value = "";
        if (els.tenant) els.tenant.value = "";
        if (els.redirectInput) els.redirectInput.value = odGetRedirectUriDefault();
        if (els.filePath) els.filePath.value = DEFAULT_FILE_PATH;
        odMsalApp = null;
        odAccount = null;
        odSetStatus("æœªæ¥ç¶š");
        odUpdateUi();
      });

      els.signIn?.addEventListener("click", async () => {
        try { await odSignIn(); }
        catch (e) { alert(e?.message || String(e)); }
      });

      els.signOut?.addEventListener("click", async () => {
        try { await odSignOut(); }
        catch (e) { alert(e?.message || String(e)); }
      });

      els.syncNow?.addEventListener("click", async () => {
        try { await odFlushQueue(); }
        catch (e) { alert(e?.message || String(e)); }
      });

      els.exportBtn?.addEventListener("click", () => {
        downloadJson();
      });

      els.importInput?.addEventListener("change", async (ev) => {
        const file = ev.target.files[0];
        if (!file) return;
        await importJsonFile(file);
        ev.target.value = "";
      });
    }

    window.addEventListener("online", () => {
      odSetSyncState("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°");
      storageFlushQueue();
    });
    window.addEventListener("offline", () => {
      odSetSyncState("ã‚ªãƒ•ãƒ©ã‚¤ãƒ³");
    });

    document.addEventListener("DOMContentLoaded", async () => {
      storageLoadData();
      migrateLegacyData();
      loadEntriesFromCache();
      loadNextMemosFromCache();
      setupEvents();
      initTabs(); // ã‚¿ãƒ–åˆæœŸåŒ–
      renderAll();
      renderNextMemos();
      odUpdateSyncStatus();
      await odAutoConnect();
      if (navigator.onLine) storageFlushQueue();
    });
  </script>
</body>

</html>